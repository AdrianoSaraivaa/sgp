{% extends "_base.html" %}
{% block title %}Painel ao Vivo ‚Äî Produ√ß√£o{% endblock %}
{% block module_name %}Painel ao Vivo{% endblock %}

{% block head_extra %}
<style>
:root {
  --bg: #f8f3f2;
  --panel: #0f1b2a;
  --border: #1f2d44;
  --card: #13243a;
  --text: #eaf2ff;

  --ok: #16a34a;
  --warn: #f59e0b;
  --late: #ef4444;
  --critical: #e11d48;

  --sep: #253249;
  --final: #1f3a2c;

  --glow-ok: rgba(22,163,74,.45);
  --glow-warn: rgba(245,158,11,.45);
  --glow-late: rgba(239,68,68,.55);
  --glow-critical: rgba(225,29,72,.6);

  --shadow-sm: 0 4px 12px rgba(0,0,0,.25);
}

/* Ajuste de margem para tela cheia */
.board-tight .top-section-wrapper, 
.board-tight .board-grid {
  margin-left:-66px;
  width: calc(100% + 16px);
}
@media (min-width:1600px) {
  .board-tight .top-section-wrapper, 
  .board-tight .board-grid {
    margin-left:-20px;
    width: calc(100% + 20px);
  }
}

/* ===== NOVO WRAPPER SUPERIOR (Banner + Audio na mesma linha) ===== */
.top-section-wrapper {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 20px;
  margin-bottom: 14px;
  min-height: 48px;
}

/* ===== Banner ROP (Flex√≠vel) ===== */
.rop-banner {
  display: none; /* Flex via JS */
  flex: 1;
  flex-direction: column;
  background: #fff1f2;
  border: 1px solid #e11d48;
  border-radius: 12px;
  padding: 8px 14px;
  box-shadow: 0 4px 12px rgba(225, 29, 72, 0.08);
}

.rop-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}
.rop-title {
  color: #9f1239;
  font-weight: 800;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.rop-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: #e11d48;
  animation: pulseDot 1.6s infinite;
}

/* Lista Horizontal de Cards */
.rop-list {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}
.rop-item {
  background: #ffffff;
  padding: 3px 10px;
  border-radius: 6px;
  color: #881337;
  font-weight: 700;
  font-size: 13px;
  border: 1px solid #fecdd3;
  border-left: 3px solid #e11d48;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  white-space: nowrap;
}

@keyframes pulseDot{0%{box-shadow:0 0 0 0 rgba(225,29,72,.45)}70%{box-shadow:0 0 0 6px rgba(225,29,72,0)}100%{box-shadow:0 0 0 0 rgba(225,29,72,0)}}

/* ===== Toolbar (√Åudio e Status) ===== */
.board-toolbar {
  flex-shrink: 0;
  margin-left: auto;
}

.status-bar-compact {
  display: flex;
  align-items: center;
  gap: 15px;
  background: rgba(255,255,255,0.6);
  padding: 4px 12px;
  border-radius: 99px;
  border: 1px solid #e2e8f0;
  backdrop-filter: blur(4px);
  height: 40px;
}

.audio-mini-ctl {
  display: flex;
  align-items: center;
  gap: 8px;
}
.btn-audio-icon {
  background: none;
  border: none;
  font-size: 16px;
  cursor: pointer;
  padding: 4px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #475569;
  transition: all .2s;
}
.btn-audio-icon:hover { background: #e2e8f0; color: #1e293b; }
.btn-audio-icon.active { color: #1d4ed8; }

#audioVolume {
  width: 60px;
  height: 4px;
  accent-color: #1d4ed8;
}

.status-text-clean {
  font-size: 12px;
  font-weight: 600;
  color: #64748b;
  display: flex;
  align-items: center;
  gap: 6px;
  border-left: 1px solid #cbd5e1;
  padding-left: 12px;
}
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; }
.status-dot.ok { background: #10b981; box-shadow: 0 0 0 2px rgba(16,185,129,0.2); }
.status-dot.loading { background: #3b82f6; animation: pulseDot 1s infinite; }
.status-dot.error { background: #ef4444; }


/* ===== Board Grid & Cards ===== */
.board-grid{display:grid;grid-template-columns: repeat(10, minmax(120px,1fr));gap:10px;align-items:start}

.board-col{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:8px;
  min-height:420px;
  box-shadow: var(--shadow-sm);
}

.board-col h3 {
  margin: 0 0 10px;
  color: #9fc3ff;
  font-weight: 800;
  font-size: 13px;
  letter-spacing: 0.04em;
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}
.board-col h3 .badge {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 99px;
  background: #0b2a4a;
  color: #a7c7ff;
  border: 1px solid #274064;
  flex-shrink: 0;
}

.kitem{position:relative;background:#1b2a41;border:1px solid #274064;border-radius:14px;padding:12px 12px;margin:8px 0;color:#e8f0ff;font-weight:900;font-size:16px;text-align:center;box-shadow: var(--shadow-sm);overflow:hidden}
.kitem .sub{display:block;font-weight:700;font-size:12px;opacity:.95;margin-top:6px}
.kitem.sep   { background:var(--sep);   border-color:#3a5075;}
.kitem.final { background:var(--final); border-color:#345f49;}

.k-ok{ background:#0d3b23; border-color:#1f7a45;}
.k-warn{ background:#5b3c0a; border-color:#a87413;}
.k-late{ background:#5a1313; border-color:#a62c2c;}
.k-critical{ background:#5a0a1f; border-color:#b41c4f;}

.kitem::after{content:"";position:absolute;inset:0;border-radius:14px;pointer-events:none;opacity:0;transition:opacity .3s}
.k-ok::after{box-shadow:0 0 0 3px var(--glow-ok), 0 0 18px 4px var(--glow-ok)}
.k-warn::after{box-shadow:0 0 0 3px var(--glow-warn), 0 0 18px 4px var(--glow-warn)}
.k-late::after{box-shadow:0 0 0 3px var(--glow-late), 0 0 18px 4px var(--glow-late)}
.k-critical::after{box-shadow:0 0 0 3px var(--glow-critical), 0 0 22px 6px var(--glow-critical)}
.k-ok:hover::after,.k-warn:hover::after,.k-late:hover::after,.k-critical:hover::after{opacity:.7}

@keyframes pulseCard { 0%{transform:scale(1)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }
.pulse{ animation: pulseCard 1.75s ease-in-out infinite; }
@media (prefers-reduced-motion: reduce){ .pulse{animation:none} }

.danger-pulse{
  border: 2px solid #e53935 !important;
  box-shadow: 0 0 0 0 rgba(107, 18, 2, 0.6);
  animation: pulseBorder 1.4s ease-in-out infinite;
}
@keyframes pulseBorder{
  0%{ box-shadow: 0 0 0 0 rgba(229,57,53,0.6) }
  70%{ box-shadow: 0 0 0 10px rgba(229,57,53,0) }
  100%{ box-shadow: 0 0 0 0 rgba(229,57,53,0) }
}

.kitem .meta{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:8px;font-weight:700}
.tag{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #2a3a56;background:#0b1a2c;color:#cfe3ff}
.tag.ok{border-color:#16a34a;color:#16a34a;background:rgba(22,163,74,.08)}
.tag.fail{border-color:#ef4444;color:#ef4444;background:rgba(239,68,68,.08)}
.tag.apr{border-color:#f59e0b;color:#f59e0b;background:rgba(245,158,11,.08)}
.tag.rep{border-color:#0ea5e9;color:#0ea5e9;background:rgba(14,165,233,.08)}
.tag.rework{border-color:#e11d48;color:#e11d48;background:rgba(225,29,72,.08)}
.tag.ws{border-color:#64748b;color:#94a3b8;background:rgba(100,116,139,.08)}
.tag.fin{border-color:#22c55e;color:#86efac;background:rgba(34,197,94,.08)}

.toast-container{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:9999}
.toast{min-width:280px;max-width:420px;background:#0f172a;color:#e2e8f0;border:1px solid #26324a;padding:12px 14px;border-radius:12px;box-shadow: var(--shadow-sm);display:flex;gap:10px;align-items:flex-start}
.toast .title{font-weight:800;margin-bottom:2px}
.toast.success{border-color:#10b981}
.toast.error{border-color:#ef4444}

.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9998}
.modal{background:#0f172a;color:#e2e8f0;border:1px solid #26324a;border-radius:14px;max-width:520px;width:92%;padding:18px;box-shadow: var(--shadow-sm)}
.modal h4{margin:0 0 8px;font-size:18px}
.modal .actions{display:flex;justify-content:flex-end;margin-top:12px}
.muted{color:#ab937c}

</style>
{% endblock %}

{% block content %}
<div class="board-tight">

  <div class="top-section-wrapper">
    
    <div id="ropBanner" class="rop-banner">
      <div class="rop-header">
        <span class="rop-dot"></span>
        <span class="rop-title">Ponto de pedido ativo</span>
      </div>
      <div id="ropList" class="rop-list">
        </div>
    </div>

    <div class="board-toolbar">
      <div class="status-bar-compact">
        <div class="audio-mini-ctl">
          <button id="btnEnableAudio" class="btn-audio-icon" title="Ativar √°udio">
            <i class="fa fa-power-off"></i>
          </button>
          <button id="btnToggleAudio" class="btn-audio-icon" title="Mutar/Desmutar">
            üîä
          </button>
          <input id="audioVolume" type="range" min="0" max="1" step="0.05" value="0.5" title="Volume">
        </div>
        <div class="status-text-clean">
          <span id="statusDot" class="status-dot loading"></span>
          <span id="statusText">Carregando...</span>
        </div>
      </div>
    </div>

  </div>

  <div id="boardGrid" class="board-grid" aria-live="polite"></div>
</div>

<div class="toast-container" id="toastContainer" aria-live="polite"></div>
<div class="modal-backdrop" id="finalBackdrop" role="dialog" aria-modal="true" aria-labelledby="finalTitle">
  <div class="modal">
    <h4 id="finalTitle">Conclu√≠do</h4>
    <div id="finalMsg" class="muted">Mensagem</div>
    <div class="actions"></div>
  </div>
</div>

{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Refs
  const grid         = document.getElementById('boardGrid');
  const statusDot    = document.getElementById('statusDot');
  const statusText   = document.getElementById('statusText');
  const toastBox     = document.getElementById('toastContainer');
  const finalBackdrop= document.getElementById('finalBackdrop');
  const finalTitle   = document.getElementById('finalTitle');
  const finalMsg     = document.getElementById('finalMsg');
  const btnEnableAudio = document.getElementById('btnEnableAudio');
  const btnToggleAudio = document.getElementById('btnToggleAudio');
  const audioVolume    = document.getElementById('audioVolume');
  const ropBanner    = document.getElementById('ropBanner');
  const ropList      = document.getElementById('ropList');

  let lastData = null;
  let lastUpdateAt = null;
  let lastBoardData = null;

  // === TABELA DE TRADU√á√ÉO (C√ìDIGO -> NOME) ===
  // Adicione mais itens aqui conforme necess√°rio
  const MODEL_NAMES = {
    "28-000": "PM700",
    "2-000":  "PM2200",
    "7-000":  "PM2100",
    "PM0025": "PM25"
  };

  // Helpers
  function h(tag, cls, text){
    const el = document.createElement(tag);
    if (cls) el.className = cls;
    if (text != null) el.textContent = text;
    return el;
  }
  function formatMMSS(seconds){
    const s = Math.max(0, Math.floor(seconds));
    const m = Math.floor(s/60);
    const ss = s % 60;
    return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  }
  function setStatus(state, text){
    statusDot.className = 'status-dot'; 
    if(state === 'status--ok') statusDot.classList.add('ok');
    else if(state === 'status--loading') statusDot.classList.add('loading');
    else statusDot.classList.add('error');
    statusText.textContent = text;
  }

  // --- L√ìGICA DO BANNER ROP COM TRADU√á√ÉO ---
  async function checkROPAlert() {
    if (!lastBoardData || !lastBoardData.needs_banner) {
        ropBanner.style.display = "none";
        return;
    }
    
    ropList.innerHTML = '';
    
    // Pega texto original: "Montar: 28-000 +20 ‚Ä¢ 2-000 +5"
    const rawText = lastBoardData.needs_banner;
    
    // Quebra em lista
    let items = rawText.split(/[‚Ä¢\n]/).map(s => s.trim()).filter(s => s.length > 0);
    if (items.length === 0) items = [rawText]; 

    items.forEach(itemText => {
        // Faz a tradu√ß√£o (Replace)
        let translatedText = itemText;
        for (const [code, name] of Object.entries(MODEL_NAMES)) {
            if (translatedText.includes(code)) {
                translatedText = translatedText.replace(code, name);
            }
        }

        // Cria card
        const div = document.createElement('div');
        div.className = 'rop-item';
        div.textContent = translatedText; 
        ropList.appendChild(div);
    });

    ropBanner.style.display = "flex"; 
  }

  // Date Parser
  function parseSinceToMs(since){
    if (!since) return NaN;
    if (/^\d{4}-\d{2}-\d{2}T/.test(since)) return Date.parse(since);
    const m = /^(\d{2})\/(\d{2})\/(\d{4})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?$/.exec(since);
    if (m) {
      const dd = parseInt(m[1], 10);
      const mm = parseInt(m[2], 10) - 1; 
      const yyyy = parseInt(m[3], 10);
      const HH = parseInt(m[4] || "0", 10);
      const MM = parseInt(m[5] || "0", 10);
      const SS = parseInt(m[6] || "0", 10);
      return new Date(yyyy, mm, dd, HH, MM, SS).getTime();
    }
    return Date.parse(since);
  }
  function getFinishTimestamp(it){
    const s = it.finished_at || it.since || null;
    return parseSinceToMs(s);
  }
  const FINAL_CFG = { max_items: 10 };

  // Toasts / Modal
  function showToast(title, message, kind='success', ttl=5000){
    const el = h('div', `toast ${kind}`);
    const body = h('div');
    body.appendChild(h('div','title',title));
    body.appendChild(h('div','',message));
    el.appendChild(body);
    toastBox.appendChild(el);
    setTimeout(()=> {
      el.style.opacity = '0'; setTimeout(()=> el.remove(), 350);
    }, ttl);
  }
  let finalTimer = null;
  function openFinalModal(title, message) {
    finalTitle.textContent = title || 'Conclu√≠do';
    finalMsg.textContent   = message || '';
    finalBackdrop.style.display = 'flex';
    if (finalTimer) clearTimeout(finalTimer);
    finalTimer = setTimeout(() => { closeFinalModal(); }, 3000);
  }
  function closeFinalModal() {
    if (finalTimer) { clearTimeout(finalTimer); finalTimer = null; }
    finalBackdrop.style.display = 'none';
  }
  finalBackdrop.addEventListener('click', (e) => { if (e.target === finalBackdrop) closeFinalModal(); });

  // Audio
  const AudioMgr = (function(){
    let ctx = null; let enabled = false; let muted = false;
    let vol = Number(localStorage.getItem('gp.audio.vol') || 0.5);
    let q = []; let speaking = false;
    function ensureCtx(){ if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)(); }
    function unlock() {
      ensureCtx();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      g.gain.value = 0.0001; o.connect(g).connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime + 0.02);
      enabled = true; localStorage.setItem('gp.audio.enabled','1');
      if(btnEnableAudio) btnEnableAudio.classList.add('active');
    }
    function setMuted(flag){
      muted = flag; localStorage.setItem('gp.audio.muted', muted ? '1':'0');
      if (btnToggleAudio) btnToggleAudio.textContent = muted ? 'üîá' : 'üîä';
    }
    function setVolume(v){ vol = Math.max(0, Math.min(1, Number(v))); localStorage.setItem('gp.audio.vol', vol); }
    function chime(preset = 'airplane'){
      if (!enabled || muted) return;
      ensureCtx(); const now = ctx.currentTime;
      const g = ctx.createGain(); g.gain.setValueAtTime(0, now);
      const lp = ctx.createBiquadFilter(); lp.type = 'lowpass';
      lp.frequency.setValueAtTime(3800, now); lp.frequency.exponentialRampToValueAtTime(1800, now + 0.35);
      const o1 = ctx.createOscillator(); o1.type = 'triangle';
      o1.frequency.setValueAtTime(932.33, now); o1.connect(lp).connect(g).connect(ctx.destination);
      const peak = 0.65 * vol;
      g.gain.linearRampToValueAtTime(peak, now + 0.015); g.gain.exponentialRampToValueAtTime(0.0009, now + 0.60);
      o1.start(now); o1.stop(now + 0.62);
      if (preset === 'airplane_dd'){
        const t2 = now + 0.18; const g2 = ctx.createGain(); g2.gain.setValueAtTime(0, t2);
        const lp2 = ctx.createBiquadFilter(); lp2.type = 'lowpass';
        lp2.frequency.setValueAtTime(3400, t2); lp2.frequency.exponentialRampToValueAtTime(1600, t2 + 0.35);
        const o2 = ctx.createOscillator(); o2.type = 'triangle';
        o2.frequency.setValueAtTime(698.46, t2); o2.connect(lp2).connect(g2).connect(ctx.destination);
        const peak2 = 0.55 * vol;
        g2.gain.linearRampToValueAtTime(peak2, t2 + 0.015); g2.gain.exponentialRampToValueAtTime(0.0009, t2 + 0.60);
        o2.start(t2); o2.stop(t2 + 0.62);
      }
    }
    function speak(text){
      if (!enabled || muted) return; if (!('speechSynthesis' in window)) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'pt-BR'; utter.rate = 1.0; utter.pitch = 1.0; utter.volume = vol;
      speaking = true; utter.onend = () => { speaking = false; pump(); };
      window.speechSynthesis.speak(utter);
    }
    function queue(text){ if (!enabled || muted) return; q.push(text); pump(); }
    let lastPlay = 0;
    function pump(){
      const now = Date.now(); if (speaking) return; if (!q.length) return;
      if (now - lastPlay < 1500) { setTimeout(pump, 300); return; }
      const text = q.shift(); lastPlay = now;
      chime('airplane'); setTimeout(()=> speak(text), 120);
    }
    (function(){
      const en = localStorage.getItem('gp.audio.enabled') === '1';
      const m  = localStorage.getItem('gp.audio.muted') === '1';
      if (en) { enabled = true; if(btnEnableAudio) btnEnableAudio.classList.add('active'); }
      setMuted(m); setVolume(vol);
    })();
    return { unlock, setMuted, setVolume, queue, chime, enabled: ()=> enabled, muted: ()=> muted };
  })();

  window.addEventListener('click', function autoUnlock(){
    try { if (!AudioMgr.enabled()) AudioMgr.unlock(); } catch(e){}
    window.removeEventListener('click', autoUnlock);
  }, { once: true });
  if (btnEnableAudio) btnEnableAudio.addEventListener('click', () => {
    AudioMgr.unlock(); showToast('√Åudio ativado', 'An√∫ncios por voz habilitados.', 'success', 2500);
  });
  if (btnToggleAudio) btnToggleAudio.addEventListener('click', () => {
    AudioMgr.setMuted(!AudioMgr.muted());
    showToast(AudioMgr.muted() ? '√Åudio desativado' : '√Åudio ativado', '', 'success', 1800);
  });
  if (audioVolume) audioVolume.addEventListener('input', (e) => AudioMgr.setVolume(e.target.value));

  // Render
  function applyStateByRatio(card, r){
    const classes = ['k-ok','k-warn','k-late','k-critical','pulse'];
    card.classList.remove(...classes);
    if (r <= 1.0) card.classList.add('k-ok');
    else if (r <= 1.3) card.classList.add('k-warn','pulse');
    else if (r <= 1.8) card.classList.add('k-late','pulse');
    else card.classList.add('k-critical','pulse');
  }
  function renderBoard(columns){
    lastData = columns || [];
    grid.innerHTML = "";
    lastData.forEach(col => {
      const colEl = h('div','board-col');
      colEl.dataset.colId = col.id || '';
      const title = h('h3','', col.title || col.id || '');
      if (col.count != null) {
        const b = h('span','badge', String(col.count));
        title.appendChild(b);
      }
      colEl.appendChild(title);
      let colItems = col.items || [];
      if ((col.id || '') === 'final') {
        colItems = colItems.slice().sort((a,b) => getFinishTimestamp(b) - getFinishTimestamp(a));
        if (FINAL_CFG.max_items != null && colItems.length > FINAL_CFG.max_items) {
          colItems = colItems.slice(0, FINAL_CFG.max_items);
        }
      }
      colItems.forEach(it => {
        const el = h('div','kitem', it.serial || '');
        if ((col.id || '') === 'sep')   el.classList.add('sep');
        if ((col.id || '') === 'final') el.classList.add('final');
        if (it.hipot_flag) { el.classList.add('danger-pulse'); el.title = "‚ö† Reprovado no Hi-Pot"; }
        const sub = h('span','sub');
        sub.dataset.since = it.since || '';
        sub.dataset.expected = it.expected_s ?? '';
        sub.dataset.modelo = it.modelo || '';
        sub.textContent = it.modelo || '';
        el.appendChild(sub);
        if (/^b[1-8]$/.test(col.id || '') && it.since && it.expected_s){
          const elapsed = (Date.now() - parseSinceToMs(it.since)) / 1000;
          applyStateByRatio(el, elapsed / it.expected_s);
        }
        const meta = h('div','meta');
        const res = (it.result || '').toString().toUpperCase();
        if (res) {
          let label = res, cls = 'tag';
          if (res === 'OK') { label = '‚úÖ OK'; cls += ' ok'; }
          else if (res === 'FAIL' || res === 'NG') { label = '‚ùå FAIL'; cls += ' fail'; }
          else if (res === 'APR') { label = '‚ö† APR'; cls += ' apr'; }
          else if (res === 'REP') { label = 'üîÑ REP'; cls += ' rep'; }
          meta.appendChild(h('span', cls, label));
        }
        if (it.rework_flag) meta.appendChild(h('span','tag rework','Retrabalho'));
        if (it.workstation) meta.appendChild(h('span','tag ws', `WS ${it.workstation}`));
        if ((col.id || '') === 'final' && it.finished_at){
          const d = new Date(it.finished_at);
          const txt = isNaN(d.getTime()) ? it.finished_at : d.toLocaleString();
          meta.appendChild(h('span','tag fin', `Conclu√≠do: ${txt}`));
        }
        if (meta.children.length) el.appendChild(meta);
        colEl.appendChild(el);
      });
      grid.appendChild(colEl);
    });
  }
  function repaintTimers(){
    if (!lastData) return;
    const subs = document.querySelectorAll('.kitem .sub');
    subs.forEach(sub => {
        const since = sub.dataset.since; const expected_s = sub.dataset.expected;
        const parentCard = sub.closest('.kitem'); const colEl = sub.closest('.board-col');
        if (!since || !expected_s || !parentCard || !colEl) return;
        const colId = colEl.dataset.colId || '';
        if (!/^b[1-8]$/.test(colId)) return;
        const start = parseSinceToMs(since); const expected = Number(expected_s);
        if (isNaN(start) || isNaN(expected)) return;
        const elapsed_s = (Date.now() - start) / 1000;
        const ratio = elapsed_s / expected;
        sub.textContent = `${sub.dataset.modelo} (${formatMMSS(elapsed_s)})`;
        applyStateByRatio(parentCard, ratio);
    });
  }
  async function loadBoard(){
    try{
      setStatus('status--loading','Atualizando...');
      const r = await fetch(`/producao/gp/painel/api/board`, {cache:'no-store'});
      if(!r.ok) throw new Error('http');
      const d = await r.json();
      if(!d.ok) throw new Error('payload');
      lastBoardData = d;
      checkROPAlert();
      renderBoard(d.columns);
      lastUpdateAt = Date.now();
      setStatus('status--ok','Atualizado agora');
      repaintTimers();
    }catch{
      setStatus('status--error','Falha ao atualizar');
    }
  }
  setInterval(() => {
    if (!lastUpdateAt) return;
    const diff = Math.floor((Date.now() - lastUpdateAt)/1000);
    if (diff <= 1) { statusText.textContent = 'Atualizado agora'; return; }
    statusText.textContent = `Atualizado h√° ${diff}s`;
  }, 1000);
  setInterval(repaintTimers, 1000);
  setInterval(loadBoard, 5000);
  loadBoard();
});
</script>
{% endblock %}