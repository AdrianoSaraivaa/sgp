{% extends "_base.html" %}
{% block title %}Painel ao Vivo ‚Äî Produ√ß√£o{% endblock %}
{% block module_name %}Painel ao Vivo{% endblock %}

{% block head_extra %}
<style>
:root {
  --bg: #f8f3f2;
  --panel: #0f1b2a;
  --border: #1f2d44;
  --card: #13243a;
  --text: #eaf2ff;
  --muted: #0552f8;

  --ok: #16a34a;
  --warn: #f59e0b;
  --late: #ef4444;
  --critical: #e11d48;

  --sep: #253249;
  --final: #1f3a2c;

  --glow-ok: rgba(22,163,74,.45);
  --glow-warn: rgba(245,158,11,.45);
  --glow-late: rgba(239,68,68,.55);
  --glow-critical: rgba(225,29,72,.6);

  --shadow-sm: 0 4px 12px rgba(0,0,0,.25);
  --shadow-md: 0 10px 24px rgba(0,0,0,.25);
}

/* ‚Äúpuxar‚Äù o painel para a esquerda */
.board-tight .board-toolbar, .board-tight .board-grid {
  margin-left:-66px;
  width: calc(100% + 16px);
}
@media (min-width:1600px) {
  .board-tight .board-toolbar, .board-tight .board-grid {
    margin-left:-20px;
    width: calc(100% + 20px);
  }
}

/* ===== Topbar nova (compacta) ===== */
.board-toolbar{
  display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px
}

/* grupos */
.group{
  background:#ffffff;
  border:1px solid #e6e8ee;
  border-radius:14px;
  padding:10px;
  display:flex;align-items:center;gap:10px;
  box-shadow:0 4px 16px rgba(15,27,42,.06);
}
.group .label{font-size:12px;color:#55657f;white-space:nowrap}

/* input-compact */
.input, .select, .btn{
  height:36px;
  border:1px solid #dbe1ea;
  border-radius:10px;
  background:#fff;
  padding:0 10px;
  outline:none;
}
.input{min-width:220px}
.select{min-width:150px}
.input:focus, .select:focus{border-color:#b7c5de; box-shadow:0 0 0 2px rgba(47,123,255,.12)}
.btn{background:#1d4ed8;border-color:#1d4ed8;color:#fff;display:inline-flex;align-items:center;gap:8px;padding:0 12px;cursor:pointer}
.btn:hover{filter:brightness(1.02)}
.btn.ghost{background:#eff4ff;color:#0f1b2a;border-color:#cfe0ff}

/* estados visuais para controles desabilitados */
.input:disabled, .select:disabled, .btn:disabled{
  opacity:.6;
  cursor:not-allowed;
  filter: grayscale(8%);
}

/* √°udio */
.audio-ctl{display:flex;align-items:center;gap:8px}
.audio-ctl .pill{height:36px;display:flex;align-items:center;gap:8px;padding:0 12px;border:1px solid #dbe1ea;border-radius:999px;background:#fff}
.audio-ctl button{height:32px;padding:0 12px;border-radius:999px;border:1px solid #dbe1ea;background:#0b2440;color:#cfe3ff}
.audio-ctl input[type="range"]{accent-color:#1d4ed8;width:140px}

/* status chip */
.status-chip{
  display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:700;border:1px solid #e6e8ee;background:#fff;min-width:160px;justify-content:center
}
.status-chip .dot{width:10px;height:10px;border-radius:50%}
.status--loading{color:#0f172a}
.status--loading .dot{background:#64748b}
.status--ok{color:#065f46}
.status--ok .dot{background:#10b981}
.status--error{color:#7f1d1d}
.status--error .dot{background:#ef4444}

/* Banner ROP (ponto de pedido) */
.rop-banner{

  display:none;align-items:center;gap: 15px;margin:8px 0 -4px;
  background:#fff7f7;border:1px solid #be0606;color:#ad0c0c;padding:8px 12px;border-radius:10px;   
}


.rop-banner .dot{width:10px;height:10px;border-radius:999px;background:#e11d48;box-shadow:0 0 0 0 rgba(225,29,72,.45);animation:pulseDot 1.6s ease-in-out infinite}
@keyframes pulseDot{0%{box-shadow:0 0 0 0 rgba(225,29,72,.45)}70%{box-shadow:0 0 0 12px rgba(225,29,72,0)}100%{box-shadow:0 0 0 0 rgba(225,29,72,0)}}

/* board */
.board-grid{display:grid;grid-template-columns: repeat(10, minmax(120px,1fr));gap:12px;align-items:start}
.board-col{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px;min-height:420px;box-shadow: var(--shadow-sm)}
.board-col h3{margin:0 0 10px;letter-spacing:.06em;color:#9fc3ff;font-weight:800;font-size:14px;display:flex;align-items:center;gap:6px}
.board-col h3 .badge{font-size:11px;padding:2px 6px;border-radius:999px;background:#0b2a4a;color:#a7c7ff;border:1px solid #274064}

/* cards */
.kitem{position:relative;background:#1b2a41;border:1px solid #274064;border-radius:14px;padding:12px 12px;margin:10px 0;color:#e8f0ff;font-weight:900;font-size:16px;text-align:center;box-shadow: var(--shadow-sm);overflow:hidden}
.kitem .sub{display:block;font-weight:700;font-size:12px;opacity:.95;margin-top:6px}
.kitem.sep   { background:var(--sep);   border-color:#3a5075;}
.kitem.final { background:var(--final); border-color:#345f49;}

/* estados com cores vivas */
.k-ok{ background:#0d3b23; border-color:#1f7a45;}
.k-warn{ background:#5b3c0a; border-color:#a87413;}
.k-late{ background:#5a1313; border-color:#a62c2c;}
.k-critical{ background:#5a0a1f; border-color:#b41c4f;}

/* glow leve usando pseudo-elemento (perf) */
.kitem::after{content:"";position:absolute;inset:0;border-radius:14px;pointer-events:none;opacity:0;transition:opacity .3s}
.k-ok::after{box-shadow:0 0 0 3px var(--glow-ok), 0 0 18px 4px var(--glow-ok)}
.k-warn::after{box-shadow:0 0 0 3px var(--glow-warn), 0 0 18px 4px var(--glow-warn)}
.k-late::after{box-shadow:0 0 0 3px var(--glow-late), 0 0 18px 4px var(--glow-late)}
.k-critical::after{box-shadow:0 0 0 3px var(--glow-critical), 0 0 22px 6px var(--glow-critical)}
.k-ok:hover::after,.k-warn:hover::after,.k-late:hover::after,.k-critical:hover::after{opacity:.7}

/* pulsar acess√≠vel p/ atrasados */
@keyframes pulseCard { 0%{transform:scale(1)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }
.pulse{ animation: pulseCard 1.75s ease-in-out infinite; }
@media (prefers-reduced-motion: reduce){ .pulse{animation:none} }

/* Toasts */
.toast-container{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:9999}
.toast{min-width:280px;max-width:420px;background:#0f172a;color:#e2e8f0;border:1px solid #26324a;padding:12px 14px;border-radius:12px;box-shadow: var(--shadow-sm);display:flex;gap:10px;align-items:flex-start}
.toast .title{font-weight:800;margin-bottom:2px}
.toast.success{border-color:#10b981}
.toast.error{border-color:#ef4444}

/* Modal finaliza√ß√£o */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9998}
.modal{background:#0f172a;color:#e2e8f0;border:1px solid #26324a;border-radius:14px;max-width:520px;width:92%;padding:18px;box-shadow: var(--shadow-sm)}
.modal h4{margin:0 0 8px;font-size:18px}
.modal .actions{display:flex;justify-content:flex-end;margin-top:12px}

/* Bot√£o estoque em alerta (ponto de pedido) */
.danger-pulse{
  border: 2px solid #e53935 !important;
  box-shadow: 0 0 0 0 rgba(107, 18, 2, 0.6);
  animation: pulseBorder 1.4s ease-in-out infinite;
}
@keyframes pulseBorder{
  0%{ box-shadow: 0 0 0 0 rgba(229,57,53,0.6) }
  70%{ box-shadow: 0 0 0 10px rgba(229,57,53,0) }
  100%{ box-shadow: 0 0 0 0 rgba(229,57,53,0) }
}

.muted{color:#ab937c}

/* cor do texto do detalhe do ROP (sem afetar outros .muted) */
.rop-banner #ropMsg { 
  color: #7a1a1a;
  font-weight: 800;
}

/* padr√£o */
.board-tight .rop-banner{
  margin-left:-66px;
  width: calc(100% + 16px);
  margin-top:-30px; /* ajuste √† vontade */
}

/* telas ‚â•1600px */
@media (min-width:1600px){
  .board-tight .rop-banner{
    margin-left:-20px;
    width: calc(100% + 20px);
    margin-top:-30px; /* ‚¨Ö um pouco mais pra cima em telas grandes */
  }
}

/* permite exibir \n como nova linha no banner */
.rop-banner #ropMsg { white-space: pre-line; }

</style>
{% endblock %}

{% block content %}
<div class="board-tight">

  <!-- Banner ROP (aparece somente quando houver necessidade) -->
  <div id="ropBanner" class="rop-banner">
    <span class="dot"></span>
    <strong>Ponto de pedido ativo</strong>
    <span id="ropMsg" class="muted"></span>
  </div>

  <div class="board-toolbar">
    <!-- Grupo: leitura manual (DESABILITADO ‚Äî s√≥ informativo) -->
    <div class="group" role="group" aria-label="Leitura manual">
      <span class="label">Leitura manual:</span>
      <input id="scanSerial" class="input" placeholder="Aguardando leitura do scanner‚Ä¶" aria-label="Serial" disabled>
      <select id="scanBench" class="select" aria-label="Bancada" disabled>
        <option value="sep">ESTOQUE</option>
        <option value="b1">BANCADA 01</option>
        <option value="b2">BANCADA 02</option>
        <option value="b3">BANCADA 03</option>
        <option value="b4">BANCADA 04</option>
        <option value="b5">HI-POT</option>
        <option value="b6">BANCADA 06</option>
        <option value="b7">BANCADA 07</option>
        <option value="b8">CHECKLIST</option>
      </select>
      <select id="scanAction" class="select" aria-label="A√ß√£o" disabled>
        <option value="start">Iniciar</option>
        <option value="finish">Finalizar</option>
      </select>
      <button id="btnScan" class="btn" type="button" disabled>
        <i class="fa fa-barcode"></i> Registrar
      </button>
    </div>

    <!-- Grupo: √°udio + status -->
    <div class="group" style="gap:12px">
      <div class="audio-ctl">
        <div class="pill">
          <button id="btnEnableAudio" title="Ativar √°udio">Ativar √°udio</button>
          <button id="btnToggleAudio" title="Ligar/Desligar avisos">üîä</button>
          <input id="audioVolume" type="range" min="0" max="1" step="0.05" value="0.5" title="Volume">
        </div>
      </div>
      <span id="status" class="status-chip status--loading">
        <span class="dot"></span><span id="statusText">Carregando‚Ä¶</span>
      </span>
    </div>
  </div>

  <div id="boardGrid" class="board-grid" aria-live="polite"></div>
</div>

<!-- Toasts -->
<div class="toast-container" id="toastContainer" aria-live="polite"></div>

<!-- Modal de finaliza√ß√£o (sem bot√£o) -->
<div class="modal-backdrop" id="finalBackdrop" role="dialog" aria-modal="true" aria-labelledby="finalTitle">
  <div class="modal">
    <h4 id="finalTitle">Conclu√≠do</h4>
    <div id="finalMsg" class="muted">Mensagem</div>
    <div class="actions"></div>
  </div>
</div>

{% endblock %}

{% block scripts_extra %}















<script>
/* ============================================================
   BLOCO 0 ‚Äî BOOT E REFER√äNCIAS DE DOM
   (Mant√©m IDs, seletores e helpers id√™nticos/compat√≠veis)
============================================================ */
document.addEventListener('DOMContentLoaded', () => {
  // --- refs DOM (iguais/compat√≠veis com seu arquivo) ---
  const grid         = document.getElementById('boardGrid');
  const statusChip   = document.getElementById('status');
  const statusText   = document.getElementById('statusText');
  const scanSerial   = document.getElementById('scanSerial');
  const scanBench    = document.getElementById('scanBench');
  const scanAction   = document.getElementById('scanAction');
  const btnScan      = document.getElementById('btnScan');

  const toastBox     = document.getElementById('toastContainer');
  const finalBackdrop= document.getElementById('finalBackdrop');
  const finalTitle   = document.getElementById('finalTitle');
  const finalMsg     = document.getElementById('finalMsg');

  const btnEnableAudio = document.getElementById('btnEnableAudio');
  const btnToggleAudio = document.getElementById('btnToggleAudio');
  const audioVolume    = document.getElementById('audioVolume');

  const ropBanner    = document.getElementById('ropBanner');
  const ropMsg       = document.getElementById('ropMsg');

  let lastData = null;
  let lastUpdateAt = null;

  /* ============================================================
     BLOCO 1 ‚Äî HELPERS E STATUS
  ============================================================ */
  function h(tag, cls, text){
    const el = document.createElement(tag);
    if (cls) el.className = cls;
    if (text != null) el.textContent = text;
    return el;
  }
  function formatMMSS(seconds){
    const s = Math.max(0, Math.floor(seconds));
    const m = Math.floor(s/60);
    const ss = s % 60;
    return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  }
  function setStatus(state, text){
    statusChip.classList.remove('status--loading','status--ok','status--error');
    statusChip.classList.add(state);
    statusText.textContent = text;
  }

  /* ============================================================
     BLOCO 2 ‚Äî MENSAGENS AMIG√ÅVEIS (novo)
     (traduz as respostas de erro do backend)
  ============================================================ */
  const ERROR_MSGS = {
    fetch_failed         : 'Falha de comunica√ß√£o com o servidor.',
    etapa_em_aberto      : 'Existe etapa em aberto na ${aberta_em}. Finalize antes.',
    transicao_invalida   : 'Transi√ß√£o inv√°lida. Esperado: ${esperado}.',
    dado_invalido        : 'Dados inv√°lidos para opera√ß√£o.',
    serial_nao_encontrado: 'Serial n√£o encontrado.',
    bench_invalido       : 'Bancada informada √© inv√°lida para este modelo.',
    acao_invalida        : 'A√ß√£o inv√°lida para o estado atual.',
    permissao_negada     : 'Voc√™ n√£o tem permiss√£o para executar esta a√ß√£o.',
    limite_tempo         : 'Tempo m√≠nimo de bancada ainda n√£o atingido.',
    conflito_concorrente : 'Outro operador atualizou este item agora h√° pouco. Tente novamente.',
    unknown              : 'Falha ao processar o scan.'
  };
  function friendlyErrorText(errObj){
    const e = errObj || {};
    // Se j√° vier uma mensagem pronta do backend, prioriza
    if (typeof e.message === 'string' && e.message.trim()){
      let msg = e.message.trim();
      if (e.hint)    msg += ` ${String(e.hint).trim()}`;
      if (e.context) msg += ` ${String(e.context).trim()}`;
      return msg.replace(/\s+/g,' ');
    }
    const key = (e.error || 'unknown');
    let tpl = ERROR_MSGS[key] || ERROR_MSGS.unknown;
    const reps = {
      '${esperado}' : e.esperado ?? e.expected ?? '',
      '${aberta_em}': e.aberta_em ?? e.open_bench ?? ''
    };
    Object.keys(reps).forEach(k => { tpl = tpl.split(k).join(String(reps[k])); });
    if (e.hint)    tpl += ` ${String(e.hint).trim()}`;
    if (e.context) tpl += ` ${String(e.context).trim()}`;
    return tpl.replace(/\s+/g,' ').trim();
  }

  /* ============================================================
     BLOCO 3 ‚Äî TOASTS (mesma sem√¢ntica do original)
  ============================================================ */
  function showToast(title, message, kind='success', ttl=5000){
    const el = h('div', `toast ${kind}`);
    const body = h('div');
    body.appendChild(h('div','title',title));
    body.appendChild(h('div','',message));
    el.appendChild(body);
    toastBox.appendChild(el);
    setTimeout(()=> {
      el.style.opacity = '0';
      setTimeout(()=> el.remove(), 350);
    }, ttl);
  }

  /* ============================================================
     BLOCO 4 ‚Äî MODAL FINALIZA√á√ÉO (open/close + autoclose)
  ============================================================ */
  let finalTimer = null;
  function openFinalModal(title, message) {
    finalTitle.textContent = title || 'Conclu√≠do';
    finalMsg.textContent   = message || '';
    finalBackdrop.style.display = 'flex';
    if (finalTimer) clearTimeout(finalTimer);
    finalTimer = setTimeout(() => { closeFinalModal(); }, 3000);
  }
  function closeFinalModal() {
    if (finalTimer) { clearTimeout(finalTimer); finalTimer = null; }
    finalBackdrop.style.display = 'none';
  }
  finalBackdrop.addEventListener('click', (e) => { if (e.target === finalBackdrop) closeFinalModal(); });

  /* ============================================================
     BLOCO 5 ‚Äî √ÅUDIO/TTS (compat√≠vel: unlock/mute/vol/chime/speak)
  ============================================================ */
  const AudioMgr = (function(){
    let ctx = null;
    let enabled = false;
    let muted = false;
    let vol = Number(localStorage.getItem('gp.audio.vol') || 0.5);
    let q = [];
    let speaking = false;

    function ensureCtx(){
      if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
    }
    function unlock() {
      ensureCtx();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      g.gain.value = 0.0001;
      o.connect(g).connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime + 0.02);
      enabled = true;
      localStorage.setItem('gp.audio.enabled','1');
    }
    function setMuted(flag){
      muted = flag;
      localStorage.setItem('gp.audio.muted', muted ? '1':'0');
      if (btnToggleAudio) btnToggleAudio.textContent = muted ? 'üîá' : 'üîä';
    }
    function setVolume(v){
      vol = Math.max(0, Math.min(1, Number(v)));
      localStorage.setItem('gp.audio.vol', vol);
    }
    function chime(preset = 'airplane'){
      if (!enabled || muted) return;
      ensureCtx();
      const now = ctx.currentTime;

      const g = ctx.createGain();
      g.gain.setValueAtTime(0, now);

      const lp = ctx.createBiquadFilter();
      lp.type = 'lowpass';
      lp.frequency.setValueAtTime(3800, now);
      lp.frequency.exponentialRampToValueAtTime(1800, now + 0.35);

      const o1 = ctx.createOscillator();
      o1.type = 'triangle';
      o1.frequency.setValueAtTime(932.33, now);
      o1.connect(lp).connect(g).connect(ctx.destination);

      const peak = 0.65 * vol;
      g.gain.linearRampToValueAtTime(peak, now + 0.015);
      g.gain.exponentialRampToValueAtTime(0.0009, now + 0.60);
      o1.start(now); o1.stop(now + 0.62);

      if (preset === 'airplane_dd'){
        const t2 = now + 0.18;
        const g2 = ctx.createGain();
        g2.gain.setValueAtTime(0, t2);

        const lp2 = ctx.createBiquadFilter();
        lp2.type = 'lowpass';
        lp2.frequency.setValueAtTime(3400, t2);
        lp2.frequency.exponentialRampToValueAtTime(1600, t2 + 0.35);

        const o2 = ctx.createOscillator();
        o2.type = 'triangle';
        o2.frequency.setValueAtTime(698.46, t2);
        o2.connect(lp2).connect(g2).connect(ctx.destination);

        const peak2 = 0.55 * vol;
        g2.gain.linearRampToValueAtTime(peak2, t2 + 0.015);
        g2.gain.exponentialRampToValueAtTime(0.0009, t2 + 0.60);
        o2.start(t2); o2.stop(t2 + 0.62);
      }
    }
    function speak(text){
      if (!enabled || muted) return;
      if (!('speechSynthesis' in window)) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'pt-BR'; utter.rate = 1.0; utter.pitch = 1.0; utter.volume = vol;
      speaking = true;
      utter.onend = () => { speaking = false; pump(); };
      window.speechSynthesis.speak(utter);
    }
    function queue(text){
      if (!enabled || muted) return;
      q.push(text); pump();
    }
    let lastPlay = 0;
    function pump(){
      const now = Date.now();
      if (speaking) return;
      if (!q.length) return;
      if (now - lastPlay < 1500) { setTimeout(pump, 300); return; }
      const text = q.shift();
      lastPlay = now;
      chime('airplane'); setTimeout(()=> speak(text), 120);
    }
    (function(){
      const en = localStorage.getItem('gp.audio.enabled') === '1';
      const m  = localStorage.getItem('gp.audio.muted') === '1';
      if (en) enabled = true; setMuted(m);
      setVolume(vol);
    })();

    return { unlock, setMuted, setVolume, queue, chime, enabled: ()=> enabled, muted: ()=> muted };
  })();

  window.addEventListener('click', function autoUnlock(){
    try { if (!AudioMgr.enabled()) AudioMgr.unlock(); } catch(e){}
    window.removeEventListener('click', autoUnlock);
  }, { once: true });

  if (btnEnableAudio) btnEnableAudio.addEventListener('click', () => {
    AudioMgr.unlock(); showToast('√Åudio ativado', 'An√∫ncios por voz habilitados.', 'success', 2500);
  });
  if (btnToggleAudio) btnToggleAudio.addEventListener('click', () => {
    AudioMgr.setMuted(!AudioMgr.muted());
    showToast(AudioMgr.muted() ? '√Åudio desativado' : '√Åudio ativado', '', 'success', 1800);
  });
  if (audioVolume) audioVolume.addEventListener('input', (e) => AudioMgr.setVolume(e.target.value));

  /* ============================================================
     BLOCO 6 ‚Äî FRASES (BENCH_SAY) + AN√öNCIO DE CONCLUS√ÉO
  ============================================================ */
  const BENCH_SAY = {
    sep:  ({modelo, serial}) => `Montagem de ${modelo}, s√©rie ${serial}. In√≠cio de montagem.`,
    b1:   ({modelo}) => `Montagem da ${modelo} na Bancada 1 finalizada.`,
    b2:   ({modelo}) => `Bancada 2 conclu√≠da para a ${modelo}.`,
    b3:   ({modelo}) => `Bancada 3 conclu√≠da. Continuidade autorizada.`,
    b4:   ({modelo}) => `Bancada 4 finalizada para o modelo ${modelo}.`,
    b5:   ({modelo}) => `Ensaios el√©tricos da ${modelo} aprovados no Hi-Pot.`,
    b6:   ({modelo}) => `Bancada 6 conclu√≠da. ${modelo} continuidade autorizada.`,
    b7:   ({modelo}) => `Bancada 7 finalizada. Preparar pr√≥xima etapa.`,
    b8:   ({modelo}) => `Checklist da ${modelo} conclu√≠do. Liberado.`,
    final:({modelo, serial, operador}) => `Montagem do ${modelo}, s√©rie ${serial}, conclu√≠da. Excelente trabalho${operador ? ', ' + operador : ''}!`
  };
  function announceBenchDone({ bench, modelo, serial, operador }){
    if (!bench) return;
    try { AudioMgr.chime('airplane_dd'); } catch(e) {}
    const sayFn = BENCH_SAY[bench] || ((ctx)=> `${bench} conclu√≠da.`);
    const phrase = sayFn({ bench, modelo, serial, operador });
    if (phrase) AudioMgr.queue(phrase);
  }


 /* ============================================================
     BLOCO 7 ‚Äî RENDER DO BOARD + APLICA√á√ÉO DE ESTADOS/TEMPO
  ============================================================ */
function applyStateByRatio(card, r){
  const classes = ['k-ok','k-warn','k-late','k-critical','pulse'];
  card.classList.remove(...classes);
  if (r <= 1.0) card.classList.add('k-ok');
  else if (r <= 1.3) card.classList.add('k-warn','pulse');
  else if (r <= 1.8) card.classList.add('k-late','pulse');
  else card.classList.add('k-critical','pulse');
}

function renderBoard(columns){
  lastData = columns || [];
  grid.innerHTML = "";

  lastData.forEach(col => {
    const colEl = h('div','board-col');
    colEl.dataset.colId = col.id || '';
    const title = h('h3','', col.title || col.id || '');
    if (col.count != null) {
      const b = h('span','badge', String(col.count));
      title.appendChild(b);
    }
    colEl.appendChild(title);

    (col.items || []).forEach(it => {
      const el = h('div','kitem', it.serial || '');
      if ((col.id || '') === 'sep')   el.classList.add('sep');
      if ((col.id || '') === 'final') el.classList.add('final');

      // NOVO: marcar card com flag de reprova√ß√£o no HiPot
      if (it.hipot_flag) {
        el.classList.add('danger-pulse'); // borda vermelha pulsante
        el.title = (el.title || '') + " ‚Ä¢ Reprovado no Hi-Pot";
      }

      const sub = h('span','sub');
      sub.dataset.since    = it.since || '';
      sub.dataset.expected = it.expected_s ?? '';
      sub.dataset.modelo   = it.modelo || '';
      sub.textContent = it.modelo || '';
      el.appendChild(sub);

      if (/^b[1-8]$/.test(col.id || '') && it.since && it.expected_s){
        const elapsed = (Date.now() - Date.parse(it.since)) / 1000;
        applyStateByRatio(el, elapsed / it.expected_s);
      }

      el.title = [
        it.modelo ? `Modelo: ${it.modelo}` : null,
        it.since  ? `Desde: ${new Date(it.since).toLocaleString()}` : null,
        it.expected_s ? `Esperado: ${formatMMSS(it.expected_s)}` : null,
        it.hipot_flag ? `‚ö† Reprovado no Hi-Pot` : null
      ].filter(Boolean).join(' ‚Ä¢ ');

      colEl.appendChild(el);
    });

    grid.appendChild(colEl);
  });
}

function repaintTimers(){
  grid.querySelectorAll('.board-col').forEach(colEl => {
    const colId = colEl.dataset.colId || '';
    const isTimedBench = /^b[1-8]$/.test(colId);

    colEl.querySelectorAll('.kitem .sub').forEach(sub => {
      const sinceISO = sub.dataset.since;
      const expected = Number(sub.dataset.expected || 0);
      const modelo   = sub.dataset.modelo || '';
      const card     = sub.parentElement;

      const baseModelo = modelo;
      if (sinceISO && expected){
        const elapsed = (Date.now() - Date.parse(sinceISO)) / 1000;
        sub.textContent = `${baseModelo} ‚Ä¢ ${formatMMSS(elapsed)}`;
        if (isTimedBench && card){
          const ratio = elapsed / expected;
          applyStateByRatio(card, ratio);
        }
      } else {
        sub.textContent = baseModelo || '';
      }
    });
  });
}


  /* ============================================================
   BLOCO 8 ‚Äî ROP / NEEDS (banner + pulso na coluna 'sep')
============================================================ */
async function checkRopAlert(){
  try{
    const r = await fetch('/producao/gp/needs', {cache:'no-store'});
    if(!r.ok) throw 0;

    const arr = await r.json();
    const needs = Array.isArray(arr) ? arr : [];

    const sepCol = [...document.querySelectorAll('.board-col')]
      .find(el => (el.dataset.colId || '') === 'sep');

    if (needs.length && sepCol){
      sepCol.classList.add('danger-pulse');
      ropBanner.style.display = 'flex';

      const nameMap = {
        '2-000'  : 'PM 2100',
        '28-000' : 'PM 2200',
        'PM0025' : 'PM 25'
      };

      const lines = needs.map(n => {
        const qty = Number(n.necessaria ?? n.qty ?? 0);
        const pretty = nameMap[n.modelo] || n.modelo || '';
        const qtyStr = String(qty).padStart(2,'0');
        return `${qtyStr} ${pretty}`;
      });

      // usa tabula√ß√£o simulada com v√°rios espa√ßos n√£o-quebr√°veis
      const sep = '\u00A0\u00A0\u00A0\u00A0\u00A0\u00A0'; // 4 espa√ßos firmes
      ropMsg.textContent = 'Precisamos produzir! ' + lines.join(sep);
    } else {
      sepCol?.classList.remove('danger-pulse');
      ropBanner.style.display = 'none';
      ropMsg.textContent = '';
    }
  }catch(e){
    // silencioso
  }
}


  /* ============================================================
     BLOCO 9 ‚Äî CLIENTE DE API (buildAnnouncement + postScan/undo)
  ============================================================ */
  function buildAnnouncement(payload, data){
    const benchMap = {
      sep: 'Separa√ß√£o de Pe√ßas',
      b1: 'Bancada 1',
      b2: 'Bancada 2',
      b3: 'Bancada 3',
      b4: 'Bancada 4',
      b5: 'Hi-Pot',
      b6: 'Bancada 6',
      b7: 'Bancada 7',
      b8: 'Checklist',
      final: 'Produto Finalizado'
    };
    const modelo = data.final_message?.modelo || '';
    const b = benchMap[payload?.bench_id] || 'Bancada';
    const act = (payload?.action === 'finish') ? 'Finalizada' : 'Atualizada';
    if (!modelo) return `Etapa ${b}. ${act}.`;
    return `Montagem da ${modelo} na ${b}. ${act}.`;
  }

  async function postScan(payload){
    try{
      const resp = await fetch('/producao/gp/painel/api/scan', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      let data = {};
      try { data = await resp.json(); } catch { data = { ok:false, error:'fetch_failed' }; }

      // -------- ERRO --------
      if (!resp.ok || !data.ok){
        const msg = friendlyErrorText(data);
        setStatus('status--error', msg || 'Falha no scan.');
        showToast('Aten√ß√£o', msg || 'Falha no scan.', 'error', 4500);
        return (data.ok ? data : { ok:false, ...data });
      }

      // -------- SUCESSO --------
      if (data.bench_done) {
        announceBenchDone({
          bench   : data.bench_done,
          modelo  : data.modelo,
          serial  : data.serial,
          operador: data.operador
        });
      }

      if (data.final_message) {
        const { titulo, mensagem, modelo, serial, operador } = data.final_message;
        showToast(titulo || 'Conclu√≠do', mensagem || '', 'success', 2500);
        openFinalModal(titulo || 'Conclu√≠do', mensagem || '');
        try {
          const phrase = buildAnnouncement(payload, data);
          if (phrase) AudioMgr.queue(phrase);
        } catch(e){}
        try {
          announceBenchDone({ bench: 'final', modelo, serial, operador });
        } catch(e){}
      }

      if (data.serial && data.moved_to){
        setStatus('status--ok', `Scan OK (${data.serial} ‚Üí ${data.moved_to})`);
      } else {
        setStatus('status--ok', 'Scan OK');
      }

      loadBoard(); // recarrega a grid ap√≥s sucesso
      return data;

    }catch(e){
      const msg = friendlyErrorText({ error:'fetch_failed', hint:String(e) });
      setStatus('status--error', msg);
      showToast('Aten√ß√£o', msg, 'error', 4500);
      return { ok:false, error:'fetch_failed', detail:String(e) };
    }
  }

  async function undoScanAPI(serial){
    try{
      const r = await fetch(`/producao/gp/painel/api/scan/undo`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({serial})
      });
      const d = await r.json().catch(()=> ({}));
      if (!r.ok || !d.ok){ return { ok:false }; }
      return d;
    }catch{
      return { ok:false };
    }
  }

  /* ============================================================
     BLOCO 10 ‚Äî CONTROLES DE SCAN MANUAL (inputs originais)
     (os campos podem estar desabilitados; fun√ß√µes mantidas)
  ============================================================ */
  async function sendScan(){
    const raw = (scanSerial?.value || '').trim();
    if (!raw){
      setStatus('status--error','Informe o serial.');
      scanSerial?.focus(); return;
    }
    let payload;
    const upper = raw.toUpperCase();
    if (upper.startsWith('B') || upper.startsWith('SEP') || raw.includes('-') || raw.includes(':')) {
      payload = { raw_scan: raw, operador: (window.OPERADOR || '').trim() };
    } else {
      payload = {
        serial:   raw,
        bench_id: scanBench?.value || 'sep',
        action:   scanAction?.value || 'start',
        operador: (window.OPERADOR || '').trim()
      };
    }
    const data = await postScan(payload);
    if (data?.ok){
      if (scanSerial) scanSerial.value = '';
    }
  }

  async function undoScan(){
    const serial = (scanSerial?.value || '').trim();
    if (!serial){ setStatus('status--error','Informe o serial para desfazer.'); return; }
    const d = await undoScanAPI(serial);
    if (!d.ok){ setStatus('status--error','Falha ao desfazer.'); return; }
    setStatus('status--ok', `Desfeito. Voltou para ${d.moved_to}.`);
    if (scanSerial) scanSerial.value = '';
    loadBoard();
  }

  if (btnScan) btnScan.addEventListener('click', sendScan);
  if (scanSerial) scanSerial.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && e.shiftKey){ e.preventDefault(); undoScan(); return; }
    if (e.key === 'Enter'){ e.preventDefault(); sendScan(); }
  });
  document.addEventListener('click', (e) => {
    const btn = e.target.closest?.('[data-action="finish"]');
    if (!btn) return;
    const serial = btn.dataset.serial;
    const benchId = btn.dataset.benchId;
    const operador = window.OPERADOR || "";
    postScan({ serial, bench_id: benchId, action: "finish", operador });
  });

  /* ============================================================
     BLOCO 11 ‚Äî LEITOR SEM FOCO (buffer + Enter)
     (Permite ler a qualquer momento sem focar input)
  ============================================================ */
  (function ScannerWithoutFocus(){
    let buffer = '';
    let timer  = null;
    const GAP_MS = 120;

    function flush(){
      const raw = buffer.trim();
      buffer = '';
      if (!raw) return;

      const upper = raw.toUpperCase();
      let payload;
      if (upper.startsWith('B') || upper.startsWith('SEP') || raw.includes('-') || raw.includes(':')) {
        payload = { raw_scan: raw, operador: (window.OPERADOR || '').trim() };
      } else {
        payload = {
          serial: raw,
          bench_id: (scanBench?.value || 'sep'),
          action: (scanAction?.value || 'start'),
          operador: (window.OPERADOR || '').trim()
        };
      }
      postScan(payload).then((data) => {
        if (data?.ok && data.serial && data.moved_to) {
          setStatus('status--ok', `Scan OK (${data.serial} ‚Üí ${data.moved_to})`);
        }
      });
    }

    document.addEventListener('keydown', (e) => {
      const t = e.target;
      const isTyping = t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable);
      if (isTyping) return;

      if (e.key === 'Enter'){
        e.preventDefault();
        clearTimeout(timer);
        flush();
        return;
      }
      if (e.key.length === 1){
        buffer += e.key;
        clearTimeout(timer);
        timer = setTimeout(flush, GAP_MS);
      }
    });
  })();

  /* ============================================================
     BLOCO 12 ‚Äî CARGA DO BOARD, TIMERS E POLLING
  ============================================================ */
  async function loadBoard(){
    try{
      setStatus('status--loading','Atualizando‚Ä¶');
      const r = await fetch(`/producao/gp/painel/api/board`, {cache:'no-store'});
      if(!r.ok) throw new Error('http');
      const d = await r.json();
      if(!d.ok) throw new Error('payload');

      renderBoard(d.columns);
      lastUpdateAt = Date.now();
      setStatus('status--ok','Atualizado agora');
      repaintTimers();

      // ROP ap√≥s carregar board
      checkRopAlert();

    }catch{
      setStatus('status--error','Falha ao atualizar');
    }
  }

  // Atualiza√ß√£o da mensagem ‚Äúh√° Xs‚Äù
  setInterval(() => {
    if (!lastUpdateAt) return;
    const diff = Math.floor((Date.now() - lastUpdateAt)/1000);
    if (diff <= 1) { statusText.textContent = 'Atualizado agora'; return; }
    statusText.textContent = `Atualizado h√° ${diff}s`;
  }, 1000);

  // Tickers
  setInterval(repaintTimers, 1000);

  setInterval(loadBoard, 5000);

  /* ============================================================
     BLOCO 13 ‚Äî UTILIDADES DE TESTE/DIAGN√ìSTICO
  ============================================================ */
  window.testVoice = () => { try { AudioMgr.chime('airplane_dd'); } catch(e){} AudioMgr.queue('Teste de voz do painel.'); };

  /* ============================================================
     BLOCO 14 ‚Äî BOOT FINAL (primeira carga)
  ============================================================ */
  loadBoard();
});
</script>


{% endblock %}
