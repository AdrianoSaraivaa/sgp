{% extends "_base.html" %}
{% block title %}Rastreabilidade ‚Ä¢ Lista de Seriais{% endblock %}
{% block module_name %}Rastreabilidade{% endblock %}

{% block content %}
<div class="card" style="padding:24px;margin:20px auto;max-width:1300px;">
  <style>
    :root {
      --color-primary:#1d4ed8;
      --color-primary-weak:#eff6ff;
      --color-text:#0f172a;
      --color-muted:#64748b;
      --color-bg:#f8fafc;
      --color-border:#e2e8f0;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --info:#3b82f6;
    }
    body{background:var(--color-bg);}
    
    /* MELHORIAS DE DESIGN */
    .filter-bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:18px;padding:10px;background:#fff;border:1px solid var(--color-border);border-radius:12px}
    .input,.select{padding:12px 14px;border:1px solid var(--color-border);border-radius:10px;min-width:220px;flex:1;font-size:16px;background:#fff;color:var(--color-text)}
    .select{min-width:170px;flex:0}
    
    /* Bot√µes */
    .btn{height:40px;padding:0 14px;border-radius:10px;border:1px solid var(--color-primary);background:var(--color-primary);color:#fff;font-weight:700;cursor:pointer; transition: background .1s;}
    .btn:hover:not(:disabled){ opacity: 0.9; }
    .btn.ghost{background:#fff;color:var(--color-text);border-color:var(--color-border)}
    .btn.small{height:34px;font-size:.9rem}

    /* Tabela */
    .table{width:100%;min-width:860px;border-collapse:separate;border-spacing:0 6px}
    thead th{padding:12px 14px;text-align:left;font-size:.8rem;color:var(--color-muted);text-transform:uppercase;border-bottom:1px solid var(--color-border)}
    tbody td{background:#fff;border:1px solid var(--color-border);padding:14px;vertical-align:top}
    tbody tr td:first-child{border-radius:10px 0 0 10px}
    tbody tr td:last-child{border-radius:0 10px 10px 0}
    .clickable-row{cursor:pointer}
    .clickable-row:hover td{background:var(--color-primary-weak)}
    .model{font-size:17px;font-weight:800;color:var(--color-text)}
    .meta{font-size:13px;color:var(--color-muted);margin-top:4px}
    .meta code{font-weight:800;color:var(--color-primary);background:var(--color-primary-weak);padding:2px 8px;border-radius:8px}
    .date-main{font-weight:800}
    .time-detail{font-size:12px;color:var(--color-muted)}
    
    /* Chips */
    .chip{display:inline-block;padding:6px 12px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid}
    .chip.ok{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .chip.warn{background:#fffbeb;color:#92400e;border-color:#fde68a}
    .chip.danger{background:#fee2e2;color:#7f1d1d;border-color:#fecaca}
    .chip.queue{background:#eff6ff;color:#1e40af;border-color:#bfdbfe}
    .chip.info{background:#e2e8f0;color:#1f2937;border-color:#cbd5e1}
    
    /* Pagina√ß√£o e Status */
    .pagination{display:flex;justify-content:space-between;align-items:center;margin-top:14px;padding-top:10px;border-top:1px solid var(--color-border)}
    .statusbar{font-size:14px;color:var(--color-muted);font-weight:600}
    
    /* Skeleton Loading */
    @keyframes shimmer{0%{background-position:-400px 0}100%{background-position:400px 0}}
    .skeleton{height:70px;border:1px solid var(--color-border);border-radius:10px;background:linear-gradient(90deg,#f1f5f9 25%,#e2e8f0 37%,#f1f5f9 63%);background-size:800px 100%;animation:shimmer 1.4s infinite}
    .sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap}

    /* ESTILOS PARA IMPRESS√ÉO */
    @media print {
        body { background: #fff !important; }
        .card { padding: 0 !important; margin: 0 auto !important; max-width: 100% !important; box-shadow: none; }
        .filter-bar, .pagination, thead th:last-child, tbody td:last-child {
            display: none; /* Oculta filtros, pagina√ß√£o e a coluna de A√ß√µes */
        }
        .table {
            border-spacing: 0;
            border-collapse: collapse;
            font-size: 10pt;
        }
        thead th, tbody td {
            border: 1px solid #ccc !important;
            padding: 8px 10px;
            border-radius: 0 !important;
            background: #fff !important;
        }
        .clickable-row:hover td { background: #fff !important; }
        .modal-wrap { display: none !important; } /* Oculta o modal de timeline caso esteja aberto */
    }
  </style>

  <div class="filter-bar" role="region" aria-label="Filtros de rastreabilidade">
    <label for="searchInput" class="sr-only">Buscar por S√©rie ou Modelo</label>
    <input id="searchInput" class="input" type="search" placeholder="Buscar (N¬∫ S√©rie, Modelo)‚Ä¶ [ENTER] para abrir detalhes" autocomplete="off">
    <label for="statusFilter" class="sr-only">Filtrar por Status</label>
    <select id="statusFilter" class="select">
      <option value="">Todos os Status</option>
      <option value="in_progress">Em Andamento</option>
      <option value="queued">Em Fila</option>
      <option value="done">Aprovado</option>
      <option value="reprovado">Reprovado</option>
    </select>
    <button id="resetBtn" class="btn ghost" title="Limpar filtros">Limpar</button>
  </div>

  <div style="overflow-x:auto">
    <table class="table" aria-describedby="statusbar">
      <thead>
        <tr>
          <th style="width:30%">Modelo / S√©rie</th>
          <th style="width:18%">Status</th>
          <th style="width:32%">√öltima Atualiza√ß√£o</th>
          <th style="width:20%;text-align:right">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div id="skeletonBox" style="margin-top:8px;display:none">
      {% for _ in range(6) %}<div class="skeleton"></div>{% endfor %}
    </div>
  </div>

  <div class="pagination">
    <div id="statusbar" class="statusbar">Carregando‚Ä¶</div>
    <div>
      <button id="prevBtn" class="btn small ghost" disabled>‚Üê Anterior</button>
      <span id="pageInfo" style="display:inline-block;min-width:130px;text-align:center;font-weight:800">P√°gina 1</span>
      <button id="nextBtn" class="btn small" disabled>Pr√≥xima ‚Üí</button>
    </div>
  </div>
</div>

<script>
(function(){
  const rows = document.getElementById('rows');
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');
  const skeletonBox = document.getElementById('skeletonBox');
  const statusbar = document.getElementById('statusbar');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const pageInfo = document.getElementById('pageInfo');
  const resetBtn = document.getElementById('resetBtn');

  const initial = { page:1, pageSize:20, search:'', status:'' };
  const state = loadFromURL();

  function loadFromURL(){
    const p = new URLSearchParams(location.search);
    return {
      page: +(p.get('page')||1),
      pageSize: 20,
      search: p.get('search') || '',
      status: p.get('status') || ''
    };
  }

  const Status = {
    map(s){
      switch((s||'').toLowerCase()){
        case 'done': return {label:'Aprovado', cls:'ok'};
        case 'in_progress': return {label:'Em Andamento', cls:'warn'};
        case 'queued': return {label:'Em Fila', cls:'queue'};
        case 'reprovado':
        case 'rejected': return {label:'Reprovado', cls:'danger'};
        default: return {label:(s||'Desconhecido'), cls:'info'};
      }
    },
    chip(s){ const m=this.map(s); return `<span class="chip ${m.cls}">${m.label}</span>`; }
  };

  function fmtDT(iso){
    if(!iso) return {d:'‚Äî', t:''};
    try{
      const d = new Date(iso);
      const pad = n=> String(n).padStart(2,'0');
      return { d:`${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`, t:`${pad(d.getHours())}:${pad(d.getMinutes())}` };
    }catch(e){ return {d:'‚Äî', t:''}; }
  }

  function setSkeleton(v){ skeletonBox.style.display = v ? 'block':'none'; rows.style.opacity = v? .3 : 1; }

  function rowHTML(it){
    const dt = fmtDT(it.ultima_atualizacao);
    const toDetails = `{{ url_for('gp_rastreabilidade_bp.rastreabilidade_detalhes', serial='__SER__') }}`.replace('__SER__', encodeURIComponent(it.serial));
    const openTimeline = `Rastreio.openTimeline('${encodeURIComponent(it.serial)}')`;
    
    // URL para relat√≥rio/PDF (ainda n√£o definido no backend, deixamos vazio por enquanto para n√£o quebrar)
    const reportUrl = ''; 
    
    // Fun√ß√£o para impress√£o da p√°gina
    const printAction = `window.print();`;

    const actions = `
      <a class="btn small ghost" href="${toDetails}">Detalhes</a>
      <a class="btn small" href="javascript:void(0)" onclick="${openTimeline}" style="margin-left:8px">Timeline</a>
      <button class="btn small" onclick="${printAction}" style="margin-left:8px; background:#475569; border-color:#475569; color:#fff;" title="Imprimir Lista">
          üñ®Ô∏è
      </button>
      ${ reportUrl ? `<a class="btn small" href="${reportUrl}" target="_blank" rel="noopener" style="margin-left:8px;background:#10b981;border-color:#10b981">Relat√≥rio PDF</a>` : ''}
    `;

    return `
      <tr class="clickable-row" onclick="location.href='${toDetails}'" tabindex="0" onkeydown="if(event.key==='Enter'){location.href='${toDetails}'}">
        <td>
          <div class="model">${it.modelo || 'MODELO INDEFINIDO'}</div>
          <div class="meta">N¬∫ S√©rie: <code>${it.serial||'-'}</code></div>
        </td>
        <td>${Status.chip(it.status)}</td>
        <td>
          <div class="date-main">${dt.d}</div>
          <div class="time-detail">${dt.t}</div>
        </td>
        <td style="text-align:right; white-space: nowrap;">${actions}</td>
      </tr>
    `;
  }

  const Rastreio = {
    async load(){
      setSkeleton(true);
      try{
        const params = new URLSearchParams();
        params.set('page', state.page);
        params.set('page_size', state.pageSize);
        if(state.search) params.set('search', state.search);
        if(state.status) params.set('status', state.status);

        const resp = await fetch(`/producao/gp/rastreabilidade/api/search?${params.toString()}`);
        const data = await resp.json();

        if(!resp.ok || !data.ok){
          throw new Error(data.error || 'Erro na API');
        }
        const items = data.items || [];
        const meta  = data.meta  || {};
        rows.innerHTML = items.length
          ? items.map(rowHTML).join('')
          : `<tr><td colspan="4" class="meta" style="text-align:center;padding:24px">Nenhum registro encontrado.</td></tr>`;

        const totalPages = +(meta.total_pages || 1);
        statusbar.textContent = `Exibindo ${items.length} itens ‚Ä¢ Total: ${meta.total_results || items.length}`;
        prevBtn.disabled = state.page<=1;
        nextBtn.disabled = state.page>=totalPages;
        pageInfo.textContent = `P√°gina ${state.page} de ${totalPages}`;

        // espelha filtros na URL
        const p = new URLSearchParams();
        p.set('page', state.page);
        if(state.search) p.set('search', state.search);
        if(state.status) p.set('status', state.status);
        history.replaceState(null, '', `${location.pathname}?${p.toString()}`);
      }catch(e){
        rows.innerHTML = `<tr><td colspan="4" style="padding:24px;color:#b91c1c">Falha ao carregar dados. ${e.message||e}</td></tr>`;
        statusbar.textContent = 'Erro ao carregar.';
      }finally{
        setSkeleton(false);
      }
    },
    async openTimeline(serial){
      try{
        // Esta rota deve retornar os dados de rastreio, incluindo gp_hipot_run.
        const resp = await fetch(`/producao/gp/trace/${serial}`); 
        const data = await resp.json();
        if (data.error) throw new Error(data.error);
        this.showTimelineModal(data);
      }catch(e){
        alert('Falha ao carregar timeline: ' + (e.message||e));
      }
    },
    getEventColor(type){
      switch(type){
        case 'work_stage': return '#3b82f6';
        case 'checklist':  return '#10b981';
        case 'hipot':      return '#f59e0b';
        default:           return '#64748b';
      }
    },
    showTimelineModal(trace){
      const wrap = document.createElement('div');
      wrap.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999';
      const box = document.createElement('div');
      box.style.cssText = 'background:#fff;border-radius:10px;max-width:860px;width:92%;max-height:85vh;overflow:auto;padding:18px;border:1px solid #e5e7eb';
      
      box.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
          <h3 style="margin:0; color: var(--color-text)">Timeline ‚Äî ${trace.order.serial}</h3>
          <button class="btn small ghost" onclick="this.closest('.modal-wrap').remove()">Fechar</button>
        </div>
        <div style="margin-bottom:15px;color:#475569; padding-left: 5px;">
            <b>Modelo:</b> ${trace.order.modelo} ‚Ä¢ 
            <b>Status:</b> <span style="font-weight: 700; color: ${trace.order.status.toLowerCase() === 'done' ? '#10b981' : '#f59e0b'}">${trace.order.status}</span> ‚Ä¢ 
            <b>Bancada Atual:</b> ${trace.order.current_bench}
        </div>
        
        <div style="padding: 0 5px;">
          ${(trace.timeline||[]).map(ev => `
            <div style="margin:12px 0;padding:12px;border-left:4px solid ${Rastreio.getEventColor(ev.type)};background:#f8fafc; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
              <div style="font-weight:800;color:#0f172a; font-size: 15px;">${ev.event}</div>
              <div style="font-size:13px;color:#64748b;margin:4px 0">
                <i class="fa fa-clock-o" aria-hidden="true"></i> ${new Date(ev.timestamp).toLocaleString()}
              </div>
              <div style="font-size:14px; margin-top: 8px;">
                ${ev.type==='work_stage' ? `
                    Bancada: <code style="background: #fff; padding: 2px 6px; border-radius: 4px;">${ev.details.bench_id}</code> 
                    ‚Ä¢ Operador: ${ev.details.operador||'‚Äî'}
                ` : ''}
                ${ev.type==='checklist'  ? `
                    Checklist: ${ev.details.template_name || '‚Äî'} 
                    ‚Ä¢ Itens OK: ${ev.details.items_ok}/${ev.details.total_items} 
                    ‚Ä¢ Operador: ${ev.details.operador || '‚Äî'}
                ` : ''}
                ${ev.type==='hipot' ? `
                    <div style="margin-top: 5px; margin-bottom: 5px; font-weight: 700;">
                        Operador: <span style="font-weight: 400;">${ev.details.operador || '‚Äî'}</span>
                    </div>
                    <div style="margin-top: 5px; background: #fff; padding: 10px; border-radius: 6px; border: 1px dashed #f59e0b33;">
                        <span style="font-weight: 700;">Tens√£o Suport√°vel:</span> <span style="font-weight: 400;">${ev.details.hp_v_obs_v || '‚Äî'} V</span>
                        ‚Ä¢ <span style="font-weight: 700;">Cont. Aterramento:</span> <span style="font-weight: 400;">${ev.details.gb_r_mohm || '‚Äî'} mŒ©</span>
                    </div>
                    <div style="margin-top: 8px;">
                        <span style="font-weight: 700;">Resultado Final:</span> 
                        <span style="color: ${ev.details.final_ok ? '#065f46' : '#7f1d1d'}; font-weight: 800; background: ${ev.details.final_ok ? '#ecfdf5' : '#fee2e2'}; padding: 4px 8px; border-radius: 99px;">
                            ${ev.details.final_ok ? '‚úÖ APROVADO' : '‚ùå REPROVADO'}
                        </span>
                    </div>
                ` : ''}
                </div>
            </div>
          `).join('')}
        </div>
      `;
      wrap.className = 'modal-wrap';
      wrap.appendChild(box);
      wrap.addEventListener('click', e => { if(e.target===wrap) wrap.remove(); });
      document.body.appendChild(wrap);
    }
  };

  // listeners
  let t=null;
  searchInput.value = state.search;
  statusFilter.value = state.status;

  searchInput.addEventListener('input', () => {
    clearTimeout(t);
    t = setTimeout(() => { state.search = searchInput.value.trim(); state.page=1; Rastreio.load(); }, 300);
  });
  searchInput.addEventListener('keyup', (e)=>{
    const v = searchInput.value.trim();
    if(e.key==='Enter'){
      if(/^[A-Za-z0-9\-]{6,}$/.test(v)){
        const toDetails = `{{ url_for('gp_rastreabilidade_bp.rastreabilidade_detalhes', serial='__SER__') }}`.replace('__SER__', encodeURIComponent(v));
        location.href = toDetails;
      }else{
        clearTimeout(t); state.search=v; state.page=1; Rastreio.load();
      }
    }
  });
  statusFilter.addEventListener('change', ()=>{ state.status = statusFilter.value; state.page=1; Rastreio.load(); });
  resetBtn.addEventListener('click', ()=>{ state.search=''; state.status=''; state.page=1; searchInput.value=''; statusFilter.value=''; Rastreio.load(); });
  prevBtn.addEventListener('click', ()=>{ if(state.page>1){ state.page--; Rastreio.load(); }});
  nextBtn.addEventListener('click', ()=>{ state.page++; Rastreio.load(); });
  window.addEventListener('popstate', ()=>{ Object.assign(state, loadFromURL()); searchInput.value=state.search; statusFilter.value=state.status; Rastreio.load(); });

  // start
  Rastreio.load();
  window.Rastreio = Rastreio; // para timeline modal
})();
</script>
{% endblock %}