{% extends "_base.html" %}

{% block title %}Rastreabilidade • {{ serial }}{% endblock %}
{% block module_name %}Rastreabilidade{% endblock %}

{% block content %}
<div class="card" style="padding:24px;margin:20px auto;max-width:1100px;">

  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" style="margin:-6px 0 14px 0; font-size:14px;">
    <a href="{{ url_for('gp_setup_bp.page_setup_home') }}">Home</a>
    <span class="muted">›</span>
    <a href="{{ url_for('gp_rastreabilidade_bp.rastreabilidade_home') }}">Produção · Rastreabilidade</a>
    <span class="muted">›</span>
    <span class="muted">Serial {{ serial }}</span>
  </nav>

  <!-- Cabeçalho -->
  <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;">
    <div>
      <h2 style="margin:0;">Rastreabilidade do Serial</h2>
      <div style="margin-top:4px;color:#667;">
        <strong>Serial:</strong> <span style="font-family:monospace">{{ serial }}</span>
      </div>
      <div id="headMeta" class="muted" style="margin-top:6px;">Carregando...</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <a class="btn" href="{{ url_for('gp_rastreabilidade_bp.rastreabilidade_home') }}">← Voltar à lista</a>
      <button id="btnReport" class="btn outline" disabled title="Em breve">Gerar Relatório</button>
    </div>
  </div>

  <hr style="margin:16px 0 20px;opacity:.15;">

  <!-- Blocos -->
  <section style="margin-bottom:18px;">
    <h3 style="margin:0 0 8px;">Linha do tempo (bancadas)</h3>
    <div id="bancadasBox" class="muted">Carregando...</div>
  </section>

  <section style="margin-bottom:18px;">
    <h3 style="margin:0 0 8px;">Bancada 5 — HiPot</h3>
    <div id="hipotBox" class="muted">Carregando...</div>
  </section>

  <section>
    <h3 style="margin:0 0 8px;">Bancada 8 — Checklist</h3>
    <div id="checklistBox" class="muted">Carregando...</div>
  </section>

</div>

<script>
(function(){
  const serial = "{{ serial }}";
  const headMeta = document.getElementById('headMeta');
  const bancadasBox = document.getElementById('bancadasBox');
  const hipotBox = document.getElementById('hipotBox');
  const checklistBox = document.getElementById('checklistBox');
  const btnReport = document.getElementById('btnReport');

  function fmt(iso){
    if(!iso) return '-';
    try{
      const d = new Date(iso);
      const p = n => String(n).padStart(2,'0');
      return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;
    }catch(e){ return iso; }
  }

  function chip(label, cls){
    return `<span class="chip ${cls||''}">${label}</span>`;
  }

  function statusLabel(st){
    const s = (st||'').toLowerCase();
    if(s==='ok' || s==='done' || s==='aprovado') return chip('Aprovado','success');
    if(s==='in_progress') return chip('Em andamento','warning');
    if(s==='queued') return chip('Em fila','');
    if(s==='fail' || s==='reprovado' || s==='rejected') return chip('Reprovado','danger');
    return chip(st||'-','');
  }

  async function load(){
    try{
      // NOVO endpoint consolidado
      const resp = await fetch(`/producao/gp/trace/${encodeURIComponent(serial)}`);
      const json = await resp.json();
      if(!json.ok) throw new Error(json.error || 'Erro na API');

      // ---- Cabeçalho meta
      const ws = json.work_stages || [];
      const last = ws.length ? ws[ws.length-1] : null;
      headMeta.innerHTML = `
        Última bancada: <code>${(last && last.bench_id) || '-'}</code>
        · Início: ${fmt(last && last.started_at)}
        · Fim: ${fmt(last && last.finished_at)}
      `;

      // ---- Bancadas (timeline simples)
      if(!ws.length){
        bancadasBox.innerHTML = `<div class="muted">Sem registros de bancadas para este serial.</div>`;
      } else {
        bancadasBox.innerHTML = ws.map(s => {
          const dur = s.elapsed_s!=null ? ` · Total: ${Math.round(s.elapsed_s/60)} min` : '';
          return `
            <div style="padding:10px 12px;border:1px solid #e4e6eb;border-radius:10px;margin-bottom:8px;">
              <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;">
                <strong>${(s.bench_id || '').toUpperCase()}</strong>
                <span class="muted">${s.operador || '-'}</span>
              </div>
              <div class="muted" style="margin-top:4px;">
                Início: ${fmt(s.started_at)} · Fim: ${fmt(s.finished_at)}${dur}
              </div>
            </div>
          `;
        }).join('');
      }

      // ---- HiPot
      const h = json.hipot || {};
      if(Object.keys(h).length === 0){
        hipotBox.innerHTML = `<div class="muted">Sem execução registrada.</div>`;
      } else {
        hipotBox.innerHTML = `
          <div>Status: ${statusLabel(h.status)}</div>
          <div class="muted" style="margin-top:4px;">Atualizado: ${fmt(h.hipot_last_at)} ${h.hipot_flag ? '· REP' : ''}</div>
        `;
      }

      // ---- Checklist
      const chk = json.checklist;
      if(!chk){
        checklistBox.innerHTML = `<div class="muted">Sem execução registrada.</div>`;
      } else {
        const items = (chk.itens||[]).map(it => {
          const res = (it.resultado||'').toLowerCase()==='ok' ? chip('OK','success') : chip('Não conforme','danger');
          const pin = it.pin_used ? ` · PIN: ${it.pin_reason || ''}` : '';
          const nota = it.nota ? ` · Nota: ${it.nota}` : '';
          const dur = it.elapsed_s!=null ? ` · ${Math.round(it.elapsed_s)}s` : '';
          return `<li style="margin:2px 0;"><strong>${it.ordem||''}.</strong> ${it.descricao||'-'} — ${res}${dur}${pin}${nota}</li>`;
        }).join('');
        checklistBox.innerHTML = `
          <div style="margin-bottom:6px;">Status: ${statusLabel(chk.status)}</div>
          <div class="muted">Início: ${fmt(chk.started_at)} · Fim: ${fmt(chk.finished_at)}</div>
          <ol style="padding-left:18px;margin:8px 0 0;">${items || '<li class="muted">Sem itens.</li>'}</ol>
        `;
      }

      // Habilita botão de relatório (placeholder)
      btnReport.disabled = false;
      btnReport.title = "Abrir relatório de rastreabilidade (em breve)";

    }catch(err){
      const msg = `Falha ao carregar detalhes: ${err.message}`;
      headMeta.textContent = msg;
      bancadasBox.textContent = msg;
      hipotBox.textContent = msg;
      checklistBox.textContent = msg;
    }
  }

  load();
})();
</script>
{% endblock %}
