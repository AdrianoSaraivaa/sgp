{% extends "_base.html" %}

{% block title %}Rastreabilidade • Lista de Seriais{% endblock %}
{% block module_name %}Rastreabilidade{% endblock %}

{% block content %}
<div class="card" style="padding:24px;margin:20px auto;max-width:1300px;">
    
    <style>
        /* Variáveis CSS para Cores e UX */
        :root {
            --color-primary: #3b82f6;
            --color-primary-light: #eff6ff;
            --color-text-dark: #0f172a;
            --color-text-muted: #64748b;
            --color-bg-light: #f8fafc;
            --color-border: #e2e8f0;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
        }

        /* 1.1. Estrutura e Container */
        .main-container {
            max-width: 1300px;
            margin: 20px auto;
            padding: 24px;
        }

        /* 1.2. Barra de Filtro */
        .filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
            padding: 10px;
            background: var(--color-bg-light);
            border-radius: 12px;
            border: 1px solid var(--color-border);
        }
        .filter-bar .input, .filter-bar .select {
            padding: 12px 14px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            min-width: 150px;
            flex-grow: 1;
            font-size: 16px;
            color: var(--color-text-dark);
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .filter-bar .input:focus, .filter-bar .select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
            outline: none;
        }
        .filter-bar .select { flex-grow: 0; }
        .filter-bar .btn.outline {
            border: 1px solid var(--color-border);
            color: var(--color-text-dark);
            background: #fff;
            padding: 12px 20px;
            font-weight: 600;
        }

        /* 1.3. Estilos de Tabela Avançados */
        .table {
            width: 100%; 
            min-width: 800px; 
            border-collapse: separate; 
            border-spacing: 0 1px;
        }
        .table thead tr {
            background: var(--color-bg-light);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .table th {
            padding: 14px 16px;
            text-align: left;
            font-size: 14px;
            color: var(--color-text-muted);
            font-weight: 600;
            text-transform: uppercase;
        }
        /* Garantindo que as células de dados se alinhem corretamente */
        .table td {
            vertical-align: top;
            padding: 18px 16px !important; /* Padding ligeiramente maior para melhor visual */
            background: #fff;
            border-bottom: 1px solid var(--color-border);
            transition: background-color 0.15s;
        }
        .clickable-row {
            cursor: pointer;
        }
        .clickable-row:hover {
            background-color: var(--color-primary-light) !important; 
        }

        /* 1.4. Conteúdo das Células */
        .model-name {
            font-size: 17px; 
            font-weight: 700; 
            color: var(--color-text-dark);
        }
        .metadata-line {
            font-size: 13px;
            color: var(--color-text-muted);
            margin-top: 4px;
        }
        .metadata-line code { 
            font-weight: 700; 
            color: var(--color-primary); 
            background: var(--color-primary-light); 
            padding: 3px 8px;
            border-radius: 6px;
            display: inline-block; 
            margin-top: 4px;
            font-family: 'Consolas', monospace;
            letter-spacing: 0.5px;
        }
        .date-main {
            font-weight: 700;
            font-size: 16px;
            color: var(--color-text-dark);
        }
        .time-detail {
            font-size: 13px; 
            color: var(--color-text-muted);
            margin-top: 2px;
            display: block;
        }

        /* 1.5. Chips de Status */
        .status-chip { 
            display: inline-block; 
            padding: 6px 14px; 
            border-radius: 999px; 
            font-size: 13px; /* Tamanho ajustado */
            font-weight: 700;
            text-transform: uppercase;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            min-width: 120px;
            text-align: center;
        }
        .chip.success { background: #dcfce7; color: #065f46; border: 1px solid #a7f3d0; } /* Aprovado */
        .chip.warning { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; } /* Em Andamento */
        .chip.danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } /* Reprovado */
        .chip.queued { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; } /* Em Fila */
        .chip.default { background: #e2e8f0; color: #333; border: 1px solid #cbd5e1; } /* Desconhecido */

        /* 1.6. Paginação e Controles */
        .pagination-controls {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 20px; 
            margin-top: 30px;
            padding: 10px 0;
            border-top: 1px solid var(--color-border);
        }
        .pagination-info {
            font-size: 14px; 
            color: var(--color-text-muted);
            font-weight: 500;
        }
        .pagination-buttons {
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        .page-indicator {
            font-size: 14px; 
            color: var(--color-text-dark); 
            min-width: 120px; 
            text-align: center;
            font-weight: 600;
        }

        /* 1.7. Loader (Skeleton) Detalhado */
        @keyframes loading-pulse {
            0% { background-position: -400px 0; }
            100% { background-position: 400px 0; }
        }
        .skeleton-row {
            padding: 18px 16px;
            background-color: #fff;
            border-bottom: 1px solid #f1f5f9;
            height: 70px;
            overflow: hidden;
            position: relative;
        }
        .skeleton-row:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(241, 245, 249, 0.6), transparent);
            animation: loading-pulse 1.5s infinite;
            background-size: 800px 100%;
        }
        .skeleton-line {
            height: 12px;
            background-color: #e2e8f0;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .skeleton-row .col-1 { width: 30%; }
        .skeleton-row .col-2 { width: 15%; }
        .skeleton-row .col-3 { width: 45%; }
        .skeleton-grid {
            display: flex;
            gap: 30px;
        }
        /* Múltiplas linhas de skeleton para simular o layout da célula */
        .skeleton-model { margin-bottom: 10px; }
        .skeleton-model .l1 { height: 16px; width: 60%; margin-bottom: 8px; }
        .skeleton-model .l2 { height: 12px; width: 40%; }
    </style>

    <div class="filter-bar">
        <input 
            type="search" 
            id="searchInput" 
            placeholder="Buscar (Nº Série, Modelo) - [ENTER] para Detalhes Imediatos..." 
            class="input"
        >
        <select id="statusFilter" class="select">
            <option value="">Todos os Status</option>
            <option value="in_progress">Em Andamento</option>
            <option value="queued">Em Fila</option>
            <option value="done">Aprovado</option>
            <option value="reprovado">Reprovado</option>
        </select>
        <button id="resetBtn" class="btn outline" title="Limpar filtros" style="flex-grow:0;">Limpar</button>
    </div>

    <div style="overflow-x:auto;">
        <table class="table">
            <thead>
                <tr>
                    <th style="width:30%;">Modelo / Série</th>
                    <th style="width:20%;">Status</th>
                    <th style="width:35%;">Última Atualização</th>
                    <th style="width:15%; text-align:right;">Ações</th>
                </tr>
            </thead>
            <tbody id="rows">
                </tbody>
        </table>
        
        <div id="skeletonLoader" style="display:none; margin-top:1px;">
            {% for i in range(7) %}
            <div class="skeleton-row">
                <div class="skeleton-grid">
                    <div style="width:30%;">
                        <div class="skeleton-model">
                            <div class="skeleton-line l1"></div>
                            <div class="skeleton-line l2"></div>
                        </div>
                    </div>
                    <div style="width:20%;">
                         <div class="skeleton-line" style="width: 60%;"></div>
                    </div>
                    <div style="width:35%;">
                         <div class="skeleton-line" style="width: 45%; margin-bottom: 8px;"></div>
                         <div class="skeleton-line" style="width: 30%;"></div>
                    </div>
                    <div style="width:15%;">
                        <div class="skeleton-line" style="width: 60%; margin-left: auto;"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
    </div>

    <div id="paginationControls" class="pagination-controls">
        <div id="messageBox" class="pagination-info">Carregando dados da API...</div>
        <div class="pagination-buttons">
            <button id="prevPageBtn" class="btn small outline" disabled>← Anterior</button>
            <span id="pageInfo" class="page-indicator">Página 1</span>
            <button id="nextPageBtn" class="btn small" disabled>Próxima →</button>
        </div>
    </div>
</div>

<script>
(function(){
    // --- 3.1. Referências DOM e Variáveis de Estado ---
    const rows = document.getElementById('rows');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const skeletonLoader = document.getElementById('skeletonLoader');
    const messageBox = document.getElementById('messageBox');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const pageInfo = document.getElementById('pageInfo');
    const resetBtn = document.getElementById('resetBtn');

    // Estado da Aplicação (Gerenciado pelo RastreioController)
    const initialState = { page: 1, search: '', status: '', totalPages: 1, pageSize: 20 };

    // --- 3.2. Funções Auxiliares (Helpers) Detalhadas ---
    const Helpers = {
        /** Formata uma string ISO Date para Data e Hora separadas. */
        fmtDate(iso){
            if(!iso) return null;
            try{
                const d = new Date(iso);
                const pad = n => String(n).padStart(2,'0');
                const datePart = `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
                const timePart = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
                return { datePart, timePart };
            }catch(e){ 
                console.error("Erro ao formatar data:", iso, e);
                return { datePart: 'Data Inválida', timePart: '-' }; 
            }
        },
        /** Mapeia status do backend para rótulo e classe CSS para o chip. */
        statusMap(s){
            switch((s||'').toLowerCase()){
                case 'done':         return {label:'Aprovado',      cls:'success'};
                case 'in_progress':  return {label:'Em Andamento',  cls:'warning'};
                case 'queued':       return {label:'Em Fila',       cls:'queued'};
                case 'rejected':
                case 'reprovado':    return {label:'Reprovado',     cls:'danger'};
                default:             return {label:(s||'Desconhecido'), cls:'default'};
            }
        },
        /** Cria o HTML para o chip de status. */
        renderStatusChip(s){
            const st = this.statusMap(s);
            return `<span class="chip status-chip ${st.cls}">${st.label}</span>`;
        },
        /** Lê os parâmetros de URL e retorna um objeto de estado inicial. */
        getParams(){
            const p = new URLSearchParams(window.location.search);
            return {
                page: Number(p.get('page')) || initialState.page,
                search: p.get('search') || initialState.search,
                status: p.get('status') || initialState.status,
                pageSize: initialState.pageSize
            };
        },
        /** Exibe o skeleton loader. */
        showLoader(){ rows.style.display = 'none'; skeletonLoader.style.display = 'block'; },
        /** Esconde o skeleton loader. */
        hideLoader(){ rows.style.display = 'contents'; skeletonLoader.style.display = 'none'; }
    };

    // --- 3.3. RastreioController - Lógica Principal e Gerenciamento de Estado ---
    const RastreioController = {
        state: { ...initialState, ...Helpers.getParams() },
        
        /** Navega para a página de detalhes do serial. */
        redirectToDetails(serial) {
            const urlTemplate = `{{ url_for('gp_rastreabilidade_bp.rastreabilidade_detalhes', serial='__SER__') }}`;
            window.location.href = urlTemplate.replace('__SER__', encodeURIComponent(serial));
        },

        /** Verifica se o valor de busca é um serial válido para navegação direta. */
        isLikelySerial(value) {
            // Critério simples: deve ser alfanumérico e ter um tamanho razoável
            return value && value.length >= 6 && /^[a-zA-Z0-9]+$/.test(value);
        },

        /** Abre a timeline consolidada usando a nova API de trace. */
        async openConsolidatedTrace(serial){
            try {
                const resp = await fetch(`/producao/gp/trace/${serial}`);
                const data = await resp.json();
                
                if (data.error) {
                    alert(`Erro: ${data.error}`);
                    return;
                }
                
                // Criar modal com a timeline consolidada
                this.showTraceModal(data);
            } catch (err) {
                alert(`Erro ao carregar timeline: ${err.message}`);
            }
        },

        /** Exibe modal com a timeline consolidada. */
        showTraceModal(traceData) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 20px; border-radius: 8px; 
                max-width: 80%; max-height: 80%; overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Timeline Consolidada - ${traceData.order.serial}</h3>
                    <button onclick="this.closest('.modal').remove()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">Fechar</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Modelo:</strong> ${traceData.order.modelo} | 
                    <strong>Status:</strong> ${traceData.order.status} | 
                    <strong>Bancada Atual:</strong> ${traceData.order.current_bench}
                </div>
                <div style="border-top: 1px solid #e2e8f0; padding-top: 15px;">
                    ${traceData.timeline.map(event => `
                        <div style="margin-bottom: 15px; padding: 10px; border-left: 3px solid ${this.getEventColor(event.type)}; background: #f8fafc;">
                            <div style="font-weight: 600; color: #0f172a;">${event.event}</div>
                            <div style="font-size: 14px; color: #64748b; margin: 5px 0;">${new Date(event.timestamp).toLocaleString()}</div>
                            <div style="font-size: 14px;">
                                ${event.type === 'work_stage' ? `Bancada: ${event.details.bench_id} | Operador: ${event.details.operador || 'N/A'}` : ''}
                                ${event.type === 'checklist' ? `Checklist | Itens OK: ${event.details.items_ok}/${event.details.total_items}` : ''}
                                ${event.type === 'hipot' ? `HiPot | Tensão: ${event.details.hp_v}V | Resultado: ${event.details.final_ok ? 'OK' : 'NOK'}` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.className = 'modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Fechar modal ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        },

        /** Retorna cor baseada no tipo de evento. */
        getEventColor(type) {
            switch(type) {
                case 'work_stage': return '#3b82f6';
                case 'checklist': return '#10b981';
                case 'hipot': return '#f59e0b';
                default: return '#64748b';
            }
        },

        /** Gera o HTML de uma linha da tabela (ROW Renderer) */
        renderRow(it){
            const clickHandler = `RastreioController.redirectToDetails('${it.serial}')`;
            const dateObj = Helpers.fmtDate(it.ultima_atualizacao);
            
            // Célula 1: Modelo e Série
            const modelCell = `
                <div class="model-name">${it.modelo || 'MODELO INDEFINIDO'}</div>
                <div class="metadata-line">
                    Nº Série: <code>${it.serial || '-'}</code>
                </div>
            `;
            
            // Célula 3: Data e Hora formatadas
            const dateCell = dateObj ? `
                <div class="date-main">${dateObj.datePart}</div>
                <span class="time-detail">${dateObj.timePart}</span>
            ` : '<div class="date-main muted">Não atualizado</div>';
            
            // Retorna a linha completa
            return `
                <tr class="clickable-row" onclick="${clickHandler}">
                    <td>${modelCell}</td>
                    <td>${Helpers.renderStatusChip(it.status)}</td>
                    <td>${dateCell}</td>
                    <td style="text-align:right;">
                        <a class="btn small outline" href="javascript:void(0);" onclick="${clickHandler}">Detalhes</a>
                        <a class="btn small" href="javascript:void(0);" onclick="RastreioController.openConsolidatedTrace('${it.serial}')" style="margin-left: 8px; background: #10b981; color: white;">Timeline</a>
                    </td>
                </tr>
            `;
        },
        
        /** Função principal: Carrega dados da API com filtros e paginação. */
        async load(){
            Helpers.showLoader();
            const { page, pageSize, search, status } = this.state;
            
            // 1. Constrói os parâmetros da requisição
            const params = new URLSearchParams();
            params.set('page', String(page));
            params.set('page_size', String(pageSize));
            if(search) params.set('search', search);
            if(status) params.set('status', status);

            try{
                // Delay MÍNIMO para evitar flicker em conexões muito rápidas (UX)
                await new Promise(r => setTimeout(r, 200)); 
                
                // 2. Chama a API
                const resp = await fetch(`/producao/gp/rastreabilidade/api/search?${params.toString()}`);
                const data = await resp.json();
                
                if(!data.ok) throw new Error(data.error || 'Erro na API');

                const items = data.items || [];
                const meta = data.meta || {};

                // 3. Atualiza o estado da paginação
                this.state.totalPages = meta.total_pages || 1;
                
                // 4. Renderiza resultados
                if(items.length === 0){
                    rows.innerHTML = `<tr><td colspan="4" class="muted" style="padding:25px; text-align:center;">Nenhum registro encontrado com os filtros atuais.</td></tr>`;
                    messageBox.textContent = `0 resultados.`;
                }else{
                    rows.innerHTML = items.map(this.renderRow).join('');
                    messageBox.textContent = `Exibindo ${items.length} itens (Total: ${meta.total_results || items.length}).`;
                }
                
                // 5. Atualiza a interface (URL, botões de paginação)
                this.updateUI();
                
            }catch(err){
                // Trata erros de conexão ou API
                rows.innerHTML = `<tr><td colspan="4" class="muted" style="color:var(--color-danger);padding:25px; text-align:center;">
                    Falha ao carregar dados. Verifique a conexão com a API: ${err.message}
                </td></tr>`;
                messageBox.textContent = `Erro: Falha na conexão com o servidor.`;
            } finally {
                // Remove o loader
                Helpers.hideLoader();
            }
        },

        /** Sincroniza o estado interno (this.state) com a interface e a URL. */
        updateUI(){
            const { page, totalPages, search, status } = this.state;
            
            // Botões de Paginação
            prevPageBtn.disabled = page <= 1;
            nextPageBtn.disabled = page >= totalPages;
            pageInfo.textContent = `Página ${page} de ${totalPages}`;
            
            // Campos de Filtro
            searchInput.value = search;
            statusFilter.value = status;
            
            // Atualiza a URL sem recarregar a página (history API)
            const p = new URLSearchParams();
            p.set('page', String(page));
            if(search) p.set('search', search);
            if(status) p.set('status', status);
            
            const newURL = `${window.location.pathname}?${p.toString()}`;
            window.history.pushState(this.state, '', newURL);
        },
        
        /** Manipulador de mudança em qualquer filtro (reseta a página para 1). */
        handleFilterChange(){
            this.state.search = searchInput.value.trim();
            this.state.status = statusFilter.value;
            this.state.page = 1; // Sempre volta para a primeira página ao filtrar
            this.load();
        },

        /** Manipulador de mudança de página (próxima/anterior). */
        handlePageChange(delta){
            const newPage = this.state.page + delta;
            if (newPage > 0 && newPage <= this.state.totalPages) {
                this.state.page = newPage;
                this.load();
            }
        },
        
        /** Manipulador de reset de todos os filtros. */
        handleReset(){
            this.state.search = initialState.search;
            this.state.status = initialState.status;
            this.state.page = initialState.page;
            this.load();
        },

        /** Inicializa a aplicação e registra os Event Listeners. */
        init(){
            window.RastreioController = this; // Expõe o Controller globalmente para uso no onclick

            // 1. Event Listeners (Busca com Debounce)
            let searchTimer = null;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimer);
                // Aguarda 300ms após a última digitação para chamar a busca
                searchTimer = setTimeout(() => this.handleFilterChange(), 300); 
            });
            
            // 2. Navegação Direta por ENTER no campo de busca
            searchInput.addEventListener('keyup', (e) => {
                const serial = e.target.value.trim();
                if (e.key === 'Enter') {
                    if (this.isLikelySerial(serial)) {
                        // Se for um serial, navega direto para detalhes
                        clearTimeout(searchTimer); 
                        this.redirectToDetails(serial);
                    } else {
                         // Se não for serial, força a busca do filtro imediatamente
                         this.handleFilterChange();
                    }
                }
            });

            // 3. Filtro de Status
            statusFilter.addEventListener('change', () => this.handleFilterChange());
            
            // 4. Paginação e Reset
            prevPageBtn.addEventListener('click', () => this.handlePageChange(-1));
            nextPageBtn.addEventListener('click', () => this.handlePageChange(1));
            resetBtn.addEventListener('click', () => this.handleReset());

            // 5. Suporte ao botão Voltar/Avançar do navegador
            window.addEventListener('popstate', (e) => {
                 // Recupera o estado (filtros e página) do histórico
                 this.state = { ...Helpers.getParams(), totalPages: this.state.totalPages };
                 this.load();
            });

            // Inicia o carregamento dos dados
            this.load();
        }
    };

    RastreioController.init();
})();
</script>
{% endblock %}