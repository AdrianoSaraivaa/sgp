{% extends "_base.html" %}
{% block title %}Relatório de Rastreabilidade • {{ serial }}{% endblock %}
{% block module_name %}Rastreabilidade{% endblock %}

{% block content %}
<style>
/* Impressão limpa */
@media print {
  header, nav, .no-print { display: none !important; }
  body { background: #fff; }
  .report { box-shadow: none !important; border: none !important; margin: 0 !important; }
}
.report { padding: 24px; margin: 20px auto; max-width: 900px; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,.04); }
.h { margin: 0 0 8px; }
.meta { color: #64748b; font-size: 13px; }
.grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.kv { display:flex; gap:8px; margin:2px 0; }
.kv b { min-width: 180px; }
.hr { border:0; border-top:1px solid #e5e7eb; margin:16px 0; }
.badge { display:inline-block; padding:3px 8px; border-radius:6px; font-size:12px; background:#eef2ff; }
.badge.ok { background:#dcfce7; }
.badge.fail { background:#fee2e2; }
.list { margin: 0; padding-left: 18px; }
</style>

<div class="report">
  <div class="no-print" style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px;">
    <a class="btn outline" href="{{ url_for('gp_rastreabilidade_bp.rastreabilidade_home') }}">← Voltar</a>
    <button class="btn" onclick="window.print()">Imprimir / Salvar PDF</button>
  </div>

  <h2 class="h">Relatório de Rastreabilidade</h2>
  <div class="meta">Serial: <b style="font-family:monospace">{{ serial }}</b></div>
  <div id="headerMeta" class="meta">Carregando...</div>

  <hr class="hr">

  <h3 class="h">1) Dados Gerais</h3>
  <div id="dadosGerais">Carregando...</div>

  <hr class="hr">

  <h3 class="h">2) Linha do Tempo (Bancadas)</h3>
  <div id="bancadas">Carregando...</div>

  <hr class="hr">

  <h3 class="h">3) HiPot</h3>
  <div id="hipot">Carregando...</div>

  <hr class="hr">

  <h3 class="h">4) Checklist (B8)</h3>
  <div id="checklist">Carregando...</div>
</div>

<script>
(function(){
  const serial = "{{ serial }}";

  function fmt(iso){
    if(!iso) return '-';
    try{
      const d = new Date(iso);
      const p = n => String(n).padStart(2,'0');
      return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;
    }catch(e){ return iso; }
  }
  function badge(s){
    const v = (s||'').toLowerCase();
    if(['ok','done','aprovado'].includes(v)) return `<span class="badge ok">APROVADO</span>`;
    if(['fail','reprovado','rejected'].includes(v)) return `<span class="badge fail">REPROVADO</span>`;
    return `<span class="badge">${s||'-'}</span>`;
  }

  async function load(){
    const headerMeta = document.getElementById('headerMeta');
    const dadosGerais = document.getElementById('dadosGerais');
    const bancadas = document.getElementById('bancadas');
    const hipot = document.getElementById('hipot');
    const checklist = document.getElementById('checklist');

    try{
      const r = await fetch(`/producao/gp/trace/${encodeURIComponent(serial)}`);
      const data = await r.json();
      if(!data.ok) throw new Error(data.error || 'Erro na API');

      // Header quick meta
      const ws = data.work_stages||[];
      const last = ws.length ? ws[ws.length-1] : null;
      headerMeta.innerHTML = `Última bancada: <b>${(last && last.bench_id) || '-'}</b> · Início: ${fmt(last && last.started_at)} · Fim: ${fmt(last && last.finished_at)}`;

      // Dados gerais (compactos)
      dadosGerais.innerHTML = `
        <div class="grid-2">
          <div>
            <div class="kv"><b>Modelo</b> <span>${data.checklist?.model_code || data.checklist?.modelo || '-'}</span></div>
            <div class="kv"><b>Status Checklist</b> <span>${badge(data.checklist?.status)}</span></div>
            <div class="kv"><b>Checklist Início</b> <span>${fmt(data.checklist?.started_at)}</span></div>
            <div class="kv"><b>Checklist Fim</b> <span>${fmt(data.checklist?.finished_at)}</span></div>
          </div>
          <div>
            <div class="kv"><b>HiPot Status</b> <span>${badge(data.hipot?.status)}</span></div>
            <div class="kv"><b>HiPot Atualizado</b> <span>${fmt(data.hipot?.hipot_last_at)}</span></div>
            <div class="kv"><b>HiPot Flag</b> <span>${data.hipot?.hipot_flag ? 'REP' : '-'}</span></div>
          </div>
        </div>
      `;

      // Linha do tempo (bancadas)
      if(!ws.length){
        bancadas.innerHTML = `<div class="meta">Sem registros de bancadas.</div>`;
      } else {
        bancadas.innerHTML = ws.map((s,i)=>{
          const dur = s.elapsed_s!=null ? ` · Duração: ${Math.round(s.elapsed_s/60)} min` : '';
          return `<div style="padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px;">
              <b>${i+1}. ${(s.bench_id||'').toUpperCase()}</b> — Operador: ${s.operador || '-'}
              <div class="meta">Início: ${fmt(s.started_at)} · Fim: ${fmt(s.finished_at)}${dur}</div>
          </div>`;
        }).join('');
      }

      // HiPot
      const h = data.hipot||{};
      hipot.innerHTML = Object.keys(h).length ? `
        <div class="kv"><b>Status</b> <span>${badge(h.status)}</span></div>
        <div class="kv"><b>Atualizado</b> <span>${fmt(h.hipot_last_at)}</span></div>
        <div class="kv"><b>Flag</b> <span>${h.hipot_flag ? 'REP' : '-'}</span></div>
      ` : `<div class="meta">Sem execução registrada.</div>`;

      // Checklist
      const chk = data.checklist;
      if(!chk){
        checklist.innerHTML = `<div class="meta">Sem execução registrada.</div>`;
      } else {
        const itens = (chk.itens||[]).map(it=>{
          const res = (it.resultado||'').toLowerCase()==='ok' ? 'OK' : 'NÃO';
          const pin = it.pin_used ? ` · PIN: ${it.pin_reason||''}` : '';
          const nota = it.nota ? ` · Nota: ${it.nota}` : '';
          const dur = it.elapsed_s!=null ? ` · ${Math.round(it.elapsed_s)}s` : '';
          return `<li>${it.ordem||'-'}. ${it.descricao||'-'} — <b>${res}</b>${dur}${pin}${nota}</li>`;
        }).join('') || '<li>Sem itens.</li>';
        const ncrs = (chk.ncrs||[]).map(n=>{
          return `<li>#${n.item_ordem||'-'} — <b>${n.categoria||''}</b>: ${n.descricao||''} <span class="meta">(${fmt(n.created_at)})</span></li>`;
        }).join('') || '<li>Sem ocorrências.</li>';
        checklist.innerHTML = `
          <div class="kv"><b>Status</b> <span>${badge(chk.status)}</span></div>
          <div class="kv"><b>Período</b> <span>${fmt(chk.started_at)} · ${fmt(chk.finished_at)}</span></div>
          <div class="grid-2" style="margin-top:10px;">
            <div>
              <h4 style="margin:0 0 6px;">Itens executados</h4>
              <ol class="list">${itens}</ol>
            </div>
            <div>
              <h4 style="margin:0 0 6px;">Ocorrências (NCR)</h4>
              <ul class="list">${ncrs}</ul>
            </div>
          </div>
        `;
      }

      // Auto-print opcional via query ?print=1
      const url = new URL(window.location.href);
      if(url.searchParams.get('print') === '1'){
        setTimeout(()=>window.print(), 300);
      }
    }catch(err){
      const msg = `Falha ao gerar relatório: ${err.message}`;
      document.getElementById('headerMeta').textContent = msg;
      document.getElementById('dadosGerais').textContent = msg;
      document.getElementById('bancadas').textContent = msg;
      document.getElementById('hipot').textContent = msg;
      document.getElementById('checklist').textContent = msg;
    }
  }

  load();
})();
</script>
{% endblock %}
